<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가게 상세정보 - 돌캐치</title>
    <th:block th:replace="~{layout/header :: headerStyle}"></th:block>
    <th:block th:replace="~{layout/footer :: footerStyle}"></th:block>
    <style>
         /* Include styles from doll/detail.html mostly */
        .main-content {
            padding-top: 24px;
            max-width: 1200px;
            margin: 0 auto;
            padding-left: 16px;
            padding-right: 16px;
        }
        .detail-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 32px;
        }

        @media (max-width: 968px) {
            .detail-container {
                grid-template-columns: 1fr;
            }
        }

        .image-section {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .main-image {
            width: 100%;
            aspect-ratio: 16/9;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .main-image .material-icons {
            font-size: 120px;
            color: rgba(255,255,255,0.7);
        }

        .info-section {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .doll-title {
            font-size: 28px;
            font-weight: 500;
            color: #212121;
            margin-bottom: 16px;
        }

        .info-divider {
            height: 1px;
            background-color: #e0e0e0;
            margin: 24px 0;
        }

        .info-items {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .info-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .info-item-content {
            flex: 1;
        }

        .info-item-label {
            font-size: 13px;
            color: #757575;
            margin-bottom: 4px;
        }

        .info-item-value {
            font-size: 15px;
            color: #212121;
            font-weight: 500;
        }

        /* Review Styles */
        .review-list {
            margin-top: 32px;
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .review-header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .review-item {
            padding: 20px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .review-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            margin-top: 8px;
            cursor: pointer;
        }

        /* Write Review Form */
        .review-form {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none; /* Initially hidden */
        }

        .review-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #6200ea;
            color: white;
        }

        .rating-input {
            display: flex;
            gap: 4px;
            color: #ddd;
            cursor: pointer;
        }

        .rating-input .material-icons.active {
            color: #ff9800;
        }

        /* 기계 힘 선택 버튼 스타일 */
        .strength-input {
            display: flex;
            gap: 8px;
        }

        .strength-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .strength-btn:hover {
            border-color: #6200ea;
            color: #6200ea;
        }

        .strength-btn.active {
            background: #6200ea;
            border-color: #6200ea;
            color: white;
        }

        /* Image Upload Styles */
        .image-upload-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .image-preview-list {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .image-preview-item {
            position: relative;
            width: 120px;
            height: 120px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            padding: 0;
        }

        .image-remove-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .image-add-btn {
            width: 120px;
            height: 120px;
            border: 2px dashed #bdbdbd;
            border-radius: 8px;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .image-add-btn:hover {
            border-color: #6200ea;
            background: #f0e6ff;
        }

        .image-add-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #e0e0e0;
            background: #fafafa;
        }

        .image-add-btn .material-icons {
            font-size: 36px;
            color: #9e9e9e;
        }

        .image-add-btn span:last-child {
            font-size: 12px;
            color: #757575;
            margin-top: 4px;
        }

        #hiddenFileInput {
            display: none;
        }

        /* Lightbox Modal Styles */
        .lightbox-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .lightbox-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            animation: zoomIn 0.3s;
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 10000;
        }

        .lightbox-close:hover {
            color: #ff5252;
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 48px;
            cursor: pointer;
            padding: 20px;
            user-select: none;
            transition: color 0.2s;
        }

        .lightbox-nav:hover {
            color: #6200ea;
        }

        .lightbox-prev {
            left: 20px;
        }

        .lightbox-next {
            right: 20px;
        }

        .lightbox-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 16px;
            border-radius: 20px;
        }

        /* Review Image Thumbnails */
        .review-images {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .review-image-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #e0e0e0;
            transition: all 0.2s;
        }

        .review-image-thumb:hover {
            border-color: #6200ea;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
<th:block th:replace="~{layout/header :: header}"></th:block>

    <!-- Lightbox Modal -->
    <div id="lightboxModal" class="lightbox-modal" onclick="closeLightbox(event)">
        <span class="lightbox-close" onclick="closeLightbox(event)">&times;</span>
        <span class="lightbox-nav lightbox-prev" onclick="navigateLightbox(-1, event)" style="display: none;">&#10094;</span>
        <div class="lightbox-content">
            <img id="lightboxImage" class="lightbox-image" src="" alt="리뷰 이미지">
        </div>
        <span class="lightbox-nav lightbox-next" onclick="navigateLightbox(1, event)" style="display: none;">&#10095;</span>
        <div class="lightbox-counter" id="lightboxCounter" style="display: none;"></div>
    </div>

    <main class="main-content">
        <div class="detail-container">
            <div class="image-section">
                <div class="main-image">
                    <span class="material-icons">store_mall_directory</span>
                </div>
            </div>

            <div class="info-section">
                <!-- Shop Data will be injected here -->
                <h1 id="shopName" class="doll-title">로딩중...</h1>

                <div class="info-divider"></div>

                <div class="info-items">
                    <div class="info-item">
                        <div class="info-item-icon">
                            <span class="material-icons">location_on</span>
                        </div>
                        <div class="info-item-content">
                            <div class="info-item-label">주소</div>
                            <div id="shopAddress" class="info-item-value">-</div>
                        </div>
                    </div>

                    <div class="info-item">
                        <div class="info-item-icon">
                            <span class="material-icons">phone</span>
                        </div>
                        <div class="info-item-content">
                            <div class="info-item-label">전화번호</div>
                            <div id="shopPhone" class="info-item-value">-</div>
                        </div>
                    </div>

                    <div class="info-item">
                        <div class="info-item-icon">
                            <span class="material-icons">videogame_asset</span>
                        </div>
                        <div class="info-item-content">
                            <div class="info-item-label">기계 수</div>
                            <div id="machineCount" class="info-item-value">-</div>
                        </div>
                    </div>

                    <div class="info-item">
                        <div class="info-item-icon">
                            <span class="material-icons">verified</span>
                        </div>
                        <div class="info-item-content">
                            <div class="info-item-label">운영 상태</div>
                            <div id="shopStatus" class="info-item-value">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review Statistics Section -->
        <div class="review-stats" style="margin-top: 32px; background: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="font-size: 20px; margin-bottom: 20px;">리뷰 통계</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <!-- 총 리뷰 수 -->
                <div style="padding: 16px; background: #f5f5f5; border-radius: 8px; text-align: center;">
                    <div style="font-size: 13px; color: #757575; margin-bottom: 8px;">총 리뷰</div>
                    <div id="statTotalReviews" style="font-size: 24px; font-weight: bold; color: #6200ea;">-</div>
                </div>
                <!-- 평균 별점 -->
                <div style="padding: 16px; background: #fff3e0; border-radius: 8px; text-align: center;">
                    <div style="font-size: 13px; color: #757575; margin-bottom: 8px;">평균 별점</div>
                    <div id="statAvgRating" style="font-size: 24px; font-weight: bold; color: #ff9800; display: flex; align-items: center; justify-content: center; gap: 4px;">
                        <span class="material-icons" style="font-size: 28px;">star</span>
                        <span>-</span>
                    </div>
                </div>
                <!-- 평균 기계 힘 -->
                <div style="padding: 16px; background: #e8f5e9; border-radius: 8px; text-align: center;">
                    <div style="font-size: 13px; color: #757575; margin-bottom: 8px;">평균 기계 힘</div>
                    <div id="statAvgMachineStrength" style="font-size: 24px; font-weight: bold; color: #4caf50;">- / 5</div>
                </div>
                <!-- 평균 대형 비용 -->
                <div style="padding: 16px; background: #fce4ec; border-radius: 8px; text-align: center;">
                    <div style="font-size: 13px; color: #757575; margin-bottom: 8px;">평균 대형 비용</div>
                    <div id="statAvgLargeCost" style="font-size: 20px; font-weight: bold; color: #e91e63;">-</div>
                </div>
                <!-- 평균 중형 비용 -->
                <div style="padding: 16px; background: #e3f2fd; border-radius: 8px; text-align: center;">
                    <div style="font-size: 13px; color: #757575; margin-bottom: 8px;">평균 중형 비용</div>
                    <div id="statAvgMediumCost" style="font-size: 20px; font-weight: bold; color: #2196f3;">-</div>
                </div>
                <!-- 평균 소형 비용 -->
                <div style="padding: 16px; background: #f3e5f5; border-radius: 8px; text-align: center;">
                    <div style="font-size: 13px; color: #757575; margin-bottom: 8px;">평균 소형 비용</div>
                    <div id="statAvgSmallCost" style="font-size: 20px; font-weight: bold; color: #9c27b0;">-</div>
                </div>
            </div>
        </div>

        <div class="review-list">
            <div class="review-header-section">
                <h2 style="font-size: 20px;">리뷰</h2>
                <button id="writeReviewBtn" class="btn btn-primary" onclick="toggleReviewForm()" style="display: none;">리뷰 작성</button>
            </div>

            <!-- Review Write Form -->
            <div id="reviewForm" class="review-form">
                <h3>리뷰 작성하기</h3>
                <form id="reviewSubmitForm" enctype="multipart/form-data">
                    <input type="hidden" id="shopIdInput" name="shopId">

                    <div class="form-group">
                        <label>별점</label>
                        <div class="rating-input" id="ratingStars">
                            <span class="material-icons" data-value="1">star</span>
                            <span class="material-icons" data-value="2">star</span>
                            <span class="material-icons" data-value="3">star</span>
                            <span class="material-icons" data-value="4">star</span>
                            <span class="material-icons" data-value="5">star</span>
                        </div>
                        <input type="hidden" name="rating" id="ratingValue" value="5">
                    </div>

                    <div class="form-group">
                        <label>기계 힘 (1: 약함 ~ 5: 강함)</label>
                        <div class="strength-input" id="strengthStars">
                            <span class="strength-btn" data-value="1">1</span>
                            <span class="strength-btn" data-value="2">2</span>
                            <span class="strength-btn active" data-value="3">3</span>
                            <span class="strength-btn" data-value="4">4</span>
                            <span class="strength-btn" data-value="5">5</span>
                        </div>
                        <input type="hidden" name="machineStrength" id="strengthValue" value="3">
                    </div>

                    <div class="form-group">
                        <label>비용 (천원 단위, 예: 3 = 3,000원)</label>
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1; position:relative;">
                                <input type="number" name="costLarge" class="form-control" placeholder="대형" min="1" max="100">
                                <span style="position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#757575; font-size:12px;">천원</span>
                            </div>
                            <div style="flex:1; position:relative;">
                                <input type="number" name="costMedium" class="form-control" placeholder="중형" min="1" max="100">
                                <span style="position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#757575; font-size:12px;">천원</span>
                            </div>
                            <div style="flex:1; position:relative;">
                                <input type="number" name="costSmall" class="form-control" placeholder="소형" min="1" max="100">
                                <span style="position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#757575; font-size:12px;">천원</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>내용</label>
                        <textarea name="content" class="form-control" rows="4" required></textarea>
                    </div>

                    <div class="form-group">
                        <label>사진 첨부 (최대 3개, 이미지 파일만 가능)</label>
                        <div class="image-upload-container">
                            <div class="image-preview-list" id="imagePreviewList">
                                <!-- 이미지 프리뷰가 여기에 추가됩니다 -->
                                <div class="image-add-btn" id="imageAddBtn" onclick="triggerFileInput()">
                                    <span class="material-icons">add_photo_alternate</span>
                                    <span>사진 추가</span>
                                </div>
                            </div>
                            <input type="file" id="hiddenFileInput" accept="image/*" onchange="handleFileSelect(event)">
                            <div style="font-size: 12px; color: #757575; margin-top: 4px;">
                                * JPG, PNG, GIF 등 이미지 파일만 업로드 가능합니다.
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">등록 완료</button>
                </form>
            </div>

            <div id="reviewsContainer">
                <!-- Reviews injected here -->
                <p style="color:#757575;">등록된 리뷰가 없습니다.</p>
            </div>

            <!-- Pagination -->
            <div id="paginationContainer" style="display: flex; justify-content: center; gap: 8px; margin-top: 24px; flex-wrap: wrap;">
                <!-- Pagination buttons will be injected here -->
            </div>
        </div>
    </main>

    <th:block th:replace="~{layout/header :: headerScript}"></th:block>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const shopId = urlParams.get('id');
        let currentPage = 0;
        const pageSize = 10;
        let isLoggedIn = false; // 로그인 상태
        let currentUserId = null; // 현재 로그인한 사용자 ID

        // 이미지 파일 관리
        let selectedImageFiles = []; // File 객체 배열
        const MAX_IMAGES = 3;

        console.log(`Detail page loaded for ID: ${shopId}`);

        // 쿠키에서 값 가져오는 헬퍼 함수
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // 로그인 상태 확인
        function checkLoginStatus() {
            // 디버깅: 모든 쿠키 출력
            console.log('=== 쿠키 디버깅 ===');
            console.log('document.cookie:', document.cookie);
            console.log('모든 쿠키:', document.cookie.split('; '));

            // 쿠키에서 access_token 확인 (JWT 방식)
            const accessToken = getCookie('access_token');
            console.log('getCookie("access_token"):', accessToken);

            // HttpOnly 쿠키는 JavaScript로 접근 불가능하므로
            // 서버에서 로그인 상태를 확인하는 API 호출
            authFetch('/api/my/info', {
                credentials: 'include' // 쿠키를 함께 전송
            })
            .then(res => {
                if (res.ok) {
                    return res.json();
                }
                throw new Error('Not logged in');
            })
            .then(result => {
                const userInfo = result.data; // ApiResponse에서 data 추출
                isLoggedIn = true;
                currentUserId = userInfo.id; // 사용자 ID 저장
                console.log('✅ 로그인 상태: true, 사용자 ID:', currentUserId);

                // 리뷰 작성 버튼 표시
                const writeReviewBtn = document.getElementById('writeReviewBtn');
                if (writeReviewBtn) {
                    writeReviewBtn.style.display = 'inline-block';
                }
            })
            .catch(err => {
                console.log('❌ 로그인 상태: false');
                isLoggedIn = false;
                currentUserId = null;
                const writeReviewBtn = document.getElementById('writeReviewBtn');
                if (writeReviewBtn) {
                    writeReviewBtn.style.display = 'none';
                }
            });
        }

        if (!shopId) {
            alert('잘못된 접근입니다. 가게 ID가 없습니다.');
            location.href = '/map';
        } else {
            // 로그인 상태 확인
            checkLoginStatus();

            document.getElementById('shopIdInput').value = shopId;

            // Fetch Shop Details
            fetch(`/api/doll-shops/${shopId}`)
                .then(async res => {
                    if(!res.ok) {
                        const error = await handleApiError(res);
                        throw error;
                    }
                    return res.json();
                })
                .then(result => {
                    const shop = result.data; // ApiResponse에서 data 추출
                    console.log('Shop details loaded:', shop);
                    document.getElementById('shopName').textContent = shop.businessName;
                    document.getElementById('shopAddress').textContent = shop.address;
                    document.getElementById('shopPhone').textContent = shop.phone || '정보 없음';
                    document.getElementById('machineCount').textContent = shop.totalGameMachines + '대';
                    document.getElementById('shopStatus').textContent = shop.isOperating ? '운영중' : '폐업';

                    // 이미지는 별도 API로 요청
                    loadShopImages(shopId);
                })
                .catch(err => {
                    console.error('가게 정보 로드 실패:', err);
                    showApiError(err, { redirectOnUnauthorized: false });
                });

            // Fetch Reviews
            fetchReviews(currentPage);

            // Fetch Review Statistics
            fetchReviewStats();
        }

        // 매장 이미지 로드 (별도 API 요청)
        function loadShopImages(shopId) {
            fetch(`/api/files?refId=${shopId}&refType=DOLL_SHOP&usage=THUMBNAIL`)
                .then(res => res.json())
                .then(images => {
                    // FileController는 List<String>을 직접 반환 (ApiResponse 아님)
                    console.log('매장 이미지 로드:', images);
                    const mainImageDiv = document.querySelector('.main-image');
                    if (images && images.length > 0) {
                        mainImageDiv.innerHTML = `<img src="${images[0]}" style="width:100%; height:100%; object-fit:cover; border-radius:8px;" onerror="this.src='/images/default-shop.png'">`;
                        mainImageDiv.style.background = 'none';
                    } else {
                        // 이미지가 없으면 기본 이미지 표시
                        mainImageDiv.innerHTML = `<img src="/images/default-shop.png" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">`;
                        mainImageDiv.style.background = 'none';
                    }
                })
                .catch(err => {
                    console.error('이미지 로드 실패:', err);
                    // 에러 시에도 기본 이미지 표시
                    const mainImageDiv = document.querySelector('.main-image');
                    mainImageDiv.innerHTML = `<img src="/images/default-shop.png" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">`;
                    mainImageDiv.style.background = 'none';
                });
        }

        function fetchReviewStats() {
            fetch(`/api/reviews/doll-shop/${shopId}/stats`)
                .then(res => res.json())
                .then(result => {
                    const stats = result.data; // ApiResponse에서 data 추출
                    console.log('리뷰 통계 로드:', stats);

                    // 총 리뷰 수
                    document.getElementById('statTotalReviews').textContent = stats.totalReviews + '개';

                    // 평균 별점 (소수점 1자리)
                    const avgRating = stats.avgRating ? stats.avgRating.toFixed(1) : '0.0';
                    document.getElementById('statAvgRating').querySelector('span:last-child').textContent = avgRating;

                    // 평균 기계 힘 (소수점 1자리)
                    const avgStrength = stats.avgMachineStrength ? stats.avgMachineStrength.toFixed(1) : '0.0';
                    document.getElementById('statAvgMachineStrength').textContent = avgStrength + ' / 5';

                    // 평균 대형 비용 (원 단위를 천원 단위로 표시)
                    const avgLarge = stats.avgLargeDollCost ? Math.round(stats.avgLargeDollCost).toLocaleString() + '원' : '데이터 없음';
                    document.getElementById('statAvgLargeCost').textContent = avgLarge;

                    // 평균 중형 비용
                    const avgMedium = stats.avgMediumDollCost ? Math.round(stats.avgMediumDollCost).toLocaleString() + '원' : '데이터 없음';
                    document.getElementById('statAvgMediumCost').textContent = avgMedium;

                    // 평균 소형 비용
                    const avgSmall = stats.avgSmallDollCost ? Math.round(stats.avgSmallDollCost).toLocaleString() + '원' : '데이터 없음';
                    document.getElementById('statAvgSmallCost').textContent = avgSmall;
                })
                .catch(err => {
                    console.error('리뷰 통계 로드 실패:', err);
                    // 에러 시에도 기본값 표시
                    document.getElementById('statTotalReviews').textContent = '0개';
                    document.getElementById('statAvgRating').querySelector('span:last-child').textContent = '0.0';
                    document.getElementById('statAvgMachineStrength').textContent = '0.0 / 5';
                    document.getElementById('statAvgLargeCost').textContent = '데이터 없음';
                    document.getElementById('statAvgMediumCost').textContent = '데이터 없음';
                    document.getElementById('statAvgSmallCost').textContent = '데이터 없음';
                });
        }

        function fetchReviews(page = 0) {
            fetch(`/api/reviews/doll-shop/${shopId}?page=${page}&size=${pageSize}`)
                .then(res => res.json())
                .then(result => {
                    const data = result.data; // ApiResponse에서 data 추출
                    const container = document.getElementById('reviewsContainer');
                    const paginationContainer = document.getElementById('paginationContainer');

                    // data는 PageResponse 객체: { content: [], page, size, totalPages, totalElements, first, last }
                    if (data.content.length === 0) {
                        container.innerHTML = '<p style="color:#757575; padding: 20px;">등록된 리뷰가 없습니다.</p>';
                        paginationContainer.innerHTML = '';
                        return;
                    }

                    // 리뷰 목록 렌더링
                    container.innerHTML = data.content.map(review => `
                        <div class="review-item">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <strong>${review.nickname || '익명'}</strong>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color:#FF9800; display:flex; align-items:center;">
                                        ${renderStars(review.rating)}
                                    </span>
                                    ${isLoggedIn && currentUserId === review.userId ?
                                        `<button onclick="deleteReview(${review.id})"
                                                style="padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            삭제
                                        </button>` : ''}
                                </div>
                            </div>
                            <div style="font-size:13px; color:#757575; margin-bottom:8px;">
                                기계 힘: ${review.machineStrength}/5
                                ${review.largeDollCost ? ` | 대형: ${review.largeDollCost.toLocaleString()}원` : ''}
                                ${review.mediumDollCost ? ` | 중형: ${review.mediumDollCost.toLocaleString()}원` : ''}
                                ${review.smallDollCost ? ` | 소형: ${review.smallDollCost.toLocaleString()}원` : ''}
                            </div>
                            <p>${review.content}</p>
                            ${review.imageUrls && review.imageUrls.length > 0 ? `
                                <div class="review-images">
                                    ${review.imageUrls.map((url, index) => `
                                        <img src="${url}"
                                             alt="리뷰 이미지 ${index + 1}"
                                             class="review-image-thumb"
                                             onclick="openLightbox(${JSON.stringify(review.imageUrls).replace(/"/g, '&quot;')}, ${index})">
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div style="margin-top:8px; font-size:12px; color:#999;">
                                ${new Date(review.createdAt).toLocaleDateString()}
                            </div>
                        </div>
                    `).join('');

                    // 페이지네이션 렌더링
                    renderPagination(data);
                })
                .catch(err => console.error('리뷰 로드 실패:', err));
        }

        function renderPagination(pageData) {
            const container = document.getElementById('paginationContainer');
            const totalPages = pageData.totalPages;
            const currentPageNum = pageData.page;

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let buttons = '';

            // 이전 버튼
            if (currentPageNum > 0) {
                buttons += `<button onclick="goToPage(${currentPageNum - 1})" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">이전</button>`;
            }

            // 페이지 번호 버튼 (최대 5개 표시)
            const startPage = Math.max(0, currentPageNum - 2);
            const endPage = Math.min(totalPages - 1, startPage + 4);

            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentPageNum;
                buttons += `<button onclick="goToPage(${i})" style="padding: 8px 12px; border: 1px solid #ddd; background: ${isActive ? '#6200ea' : 'white'}; color: ${isActive ? 'white' : 'black'}; border-radius: 4px; cursor: pointer; font-weight: ${isActive ? 'bold' : 'normal'};">${i + 1}</button>`;
            }

            // 다음 버튼
            if (currentPageNum < totalPages - 1) {
                buttons += `<button onclick="goToPage(${currentPageNum + 1})" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">다음</button>`;
            }

            container.innerHTML = buttons;
        }

        function goToPage(page) {
            currentPage = page;
            fetchReviews(page);
            // 리뷰 섹션으로 스크롤
            document.querySelector('.review-list').scrollIntoView({ behavior: 'smooth' });
        }

        function renderStars(rating) {
            let stars = '';
            for(let i=0; i<5; i++) {
                stars += `<span class="material-icons" style="font-size:16px;">${i < rating ? 'star' : 'star_border'}</span>`;
            }
            return stars;
        }

        // Toggle Review Form
        function toggleReviewForm() {
            const form = document.getElementById('reviewForm');
            if (form.style.display === 'block') {
                form.style.display = 'none';
            } else {
                form.style.display = 'block';
            }
        }

        // Star Rating Logic
        document.getElementById('ratingStars').addEventListener('click', function(e) {
            if(e.target.tagName === 'SPAN') {
                const value = e.target.getAttribute('data-value');
                document.getElementById('ratingValue').value = value;
                updateStarDisplay(value);
            }
        });

        function updateStarDisplay(value) {
            const stars = document.querySelectorAll('#ratingStars .material-icons');
            stars.forEach((star, index) => {
                if (index < value) {
                    star.classList.add('active');
                    star.textContent = 'star';
                } else {
                    star.classList.remove('active');
                    star.textContent = 'star_border';
                }
            });
        }
        updateStarDisplay(5); // initialize

        // 기계 힘 선택 로직
        document.getElementById('strengthStars').addEventListener('click', function(e) {
            if(e.target.classList.contains('strength-btn')) {
                const value = e.target.getAttribute('data-value');
                document.getElementById('strengthValue').value = value;
                updateStrengthDisplay(value);
            }
        });

        function updateStrengthDisplay(value) {
            const btns = document.querySelectorAll('#strengthStars .strength-btn');
            btns.forEach(btn => {
                if (btn.getAttribute('data-value') === value) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // ========== 이미지 파일 관리 함수 ==========

        // 파일 선택 트리거
        function triggerFileInput() {
            if (selectedImageFiles.length >= MAX_IMAGES) {
                alert(`최대 ${MAX_IMAGES}개의 이미지만 업로드할 수 있습니다.`);
                return;
            }
            document.getElementById('hiddenFileInput').click();
        }

        // 파일 선택 핸들러
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 이미지 파일 검증
            if (!file.type.startsWith('image/')) {
                alert('이미지 파일만 업로드 가능합니다. (JPG, PNG, GIF 등)');
                event.target.value = ''; // 파일 input 초기화
                return;
            }

            // 최대 개수 확인
            if (selectedImageFiles.length >= MAX_IMAGES) {
                alert(`최대 ${MAX_IMAGES}개의 이미지만 업로드할 수 있습니다.`);
                event.target.value = '';
                return;
            }

            // 파일 추가
            selectedImageFiles.push(file);
            event.target.value = ''; // 다음 선택을 위해 초기화

            // UI 업데이트
            updateImagePreview();
        }

        // 이미지 삭제
        function removeImage(index) {
            selectedImageFiles.splice(index, 1);
            updateImagePreview();
        }

        // 이미지 프리뷰 업데이트
        function updateImagePreview() {
            const container = document.getElementById('imagePreviewList');
            const addBtn = document.getElementById('imageAddBtn');

            // 기존 프리뷰 제거 (추가 버튼 제외)
            const previews = container.querySelectorAll('.image-preview-item');
            previews.forEach(preview => preview.remove());

            // 이미지 프리뷰 추가
            selectedImageFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="미리보기 ${index + 1}">
                        <button type="button" class="image-remove-btn" onclick="removeImage(${index})">
                            <span class="material-icons" style="font-size: 16px;">close</span>
                        </button>
                    `;
                    container.insertBefore(previewItem, addBtn);
                };
                reader.readAsDataURL(file);
            });

            // 추가 버튼 상태 업데이트
            if (selectedImageFiles.length >= MAX_IMAGES) {
                addBtn.classList.add('disabled');
                addBtn.onclick = null;
                addBtn.style.cursor = 'not-allowed';
            } else {
                addBtn.classList.remove('disabled');
                addBtn.onclick = triggerFileInput;
                addBtn.style.cursor = 'pointer';
            }

            // 추가 버튼 텍스트 업데이트
            addBtn.querySelector('span:last-child').textContent =
                `사진 추가 (${selectedImageFiles.length}/${MAX_IMAGES})`;
        }

        // Review Submit
        document.getElementById('reviewSubmitForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // 로그인 확인
            if (!isLoggedIn) {
                alert('로그인이 필요합니다.');
                window.location.href = '/login';
                return;
            }

            const formData = new FormData(this);

            // JSON 형태로 데이터 구성 (비용은 천원 단위 입력 -> 원 단위 저장)
            const reviewData = {
                dollShopId: parseInt(shopId),
                content: formData.get('content'),
                rating: parseInt(formData.get('rating')),
                machineStrength: parseInt(formData.get('machineStrength')),
                largeDollCost: formData.get('costLarge') ? parseInt(formData.get('costLarge')) * 1000 : null,
                mediumDollCost: formData.get('costMedium') ? parseInt(formData.get('costMedium')) * 1000 : null,
                smallDollCost: formData.get('costSmall') ? parseInt(formData.get('costSmall')) * 1000 : null
            };

            console.log('리뷰 제출:', reviewData);

            // HttpOnly 쿠키는 자동으로 전송되므로 credentials: 'include' 사용
            authFetch('/api/reviews', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include', // 쿠키를 자동으로 포함
                body: JSON.stringify(reviewData)
            })
            .then(async res => {
                if (!res.ok) {
                    const error = await handleApiError(res);
                    showApiError(error);
                    throw error; // catch로 전달
                }
                return res.json();
            })
            .then(result => {
                const data = result ? result.data : null; // ApiResponse에서 data 추출
                if (data && data.id) {
                    console.log('리뷰 등록 성공:', data);

                    // 선택된 이미지 파일이 있으면 업로드
                    if (selectedImageFiles.length > 0) {
                        console.log('파일 업로드 시작:', selectedImageFiles.length, '개');
                        uploadReviewFiles(data.id, selectedImageFiles);
                    } else {
                        alert('리뷰가 등록되었습니다!');
                        window.location.reload();
                    }
                } else {
                    alert('리뷰가 등록되었습니다!');
                    window.location.reload();
                }
            })
            .catch(err => {
                console.error('리뷰 등록 에러:', err);
                // showApiError에서 이미 처리했으므로 추가 alert 불필요
            });
        });

        // 리뷰 파일 업로드 함수
        function uploadReviewFiles(reviewId, files) {
            const fileFormData = new FormData();

            // 파일 추가
            files.forEach(file => {
                fileFormData.append('files', file);
            });

            // 파라미터 추가
            fileFormData.append('refId', reviewId);
            fileFormData.append('refType', 'REVIEW');
            fileFormData.append('usage', 'IMAGES');

            authFetch('/api/files/upload', {
                method: 'POST',
                credentials: 'include',
                body: fileFormData // multipart/form-data는 자동 설정
            })
            .then(res => {
                if (res.ok) {
                    console.log('파일 업로드 성공');
                    alert('리뷰와 사진이 등록되었습니다!');
                } else {
                    console.warn('파일 업로드 실패 (리뷰는 등록됨)');
                    alert('리뷰는 등록되었으나 사진 업로드에 실패했습니다.');
                }
                window.location.reload();
            })
            .catch(err => {
                console.error('파일 업로드 에러:', err);
                alert('리뷰는 등록되었으나 사진 업로드에 실패했습니다.');
                window.location.reload();
            });
        }

        // ========== 라이트박스 (이미지 뷰어) 함수 ==========
        let currentLightboxImages = [];
        let currentLightboxIndex = 0;

        // 리뷰 삭제
        function deleteReview(reviewId) {
            if (!confirm('정말 이 리뷰를 삭제하시겠습니까?\n삭제 후 재등록이 필요합니다.')) {
                return;
            }

            authFetch(`/api/reviews/${reviewId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(async res => {
                if (res.ok) {
                    alert('리뷰가 삭제되었습니다.');
                    fetchReviews(currentPage); // 현재 페이지 새로고침
                    fetchReviewStats(); // 통계도 새로고침
                } else {
                    const error = await handleApiError(res);
                    showApiError(error);
                }
            })
            .catch(err => {
                console.error('리뷰 삭제 오류:', err);
                if (err.message) {
                    alert(err.message);
                } else {
                    alert('리뷰 삭제 중 오류가 발생했습니다.');
                }
            });
        }

        // 라이트박스 열기
        function openLightbox(imageUrls, index) {
            currentLightboxImages = imageUrls;
            currentLightboxIndex = index;

            const modal = document.getElementById('lightboxModal');
            const image = document.getElementById('lightboxImage');
            const prevBtn = document.querySelector('.lightbox-prev');
            const nextBtn = document.querySelector('.lightbox-next');
            const counter = document.getElementById('lightboxCounter');

            // 이미지 설정
            image.src = imageUrls[index];

            // 네비게이션 버튼 표시 (이미지가 2개 이상일 때)
            if (imageUrls.length > 1) {
                prevBtn.style.display = 'block';
                nextBtn.style.display = 'block';
                counter.style.display = 'block';
                counter.textContent = `${index + 1} / ${imageUrls.length}`;
            } else {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                counter.style.display = 'none';
            }

            // 모달 표시
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // 스크롤 방지
        }

        // 라이트박스 닫기
        function closeLightbox(event) {
            // 이미지 자체를 클릭한 경우는 닫지 않음
            if (event && event.target.id === 'lightboxImage') {
                return;
            }

            const modal = document.getElementById('lightboxModal');
            modal.style.display = 'none';
            document.body.style.overflow = ''; // 스크롤 복원
            currentLightboxImages = [];
            currentLightboxIndex = 0;
        }

        // 라이트박스 네비게이션
        function navigateLightbox(direction, event) {
            event.stopPropagation(); // 모달 닫힘 방지

            currentLightboxIndex += direction;

            // 순환 처리
            if (currentLightboxIndex < 0) {
                currentLightboxIndex = currentLightboxImages.length - 1;
            } else if (currentLightboxIndex >= currentLightboxImages.length) {
                currentLightboxIndex = 0;
            }

            const image = document.getElementById('lightboxImage');
            const counter = document.getElementById('lightboxCounter');

            image.src = currentLightboxImages[currentLightboxIndex];
            counter.textContent = `${currentLightboxIndex + 1} / ${currentLightboxImages.length}`;
        }

        // 키보드 이벤트 (ESC, 좌우 화살표)
        document.addEventListener('keydown', function(event) {
            const modal = document.getElementById('lightboxModal');
            if (modal.style.display === 'block') {
                if (event.key === 'Escape') {
                    closeLightbox();
                } else if (event.key === 'ArrowLeft') {
                    if (currentLightboxImages.length > 1) {
                        navigateLightbox(-1, event);
                    }
                } else if (event.key === 'ArrowRight') {
                    if (currentLightboxImages.length > 1) {
                        navigateLightbox(1, event);
                    }
                }
            }
        });

        // Check Login Status for header (Simplified check, assuming header script handles it usually, but here adding minimal check)
        // Actually layout/header usually handles user menu.
    </script>
<th:block th:replace="~{layout/footer :: footer}"></th:block>

</body>
</html>

