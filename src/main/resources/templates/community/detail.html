<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ - Ïª§ÎÆ§ÎãàÌã∞</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <th:block th:replace="~{layout/header :: headerStyle}"></th:block>
    <th:block th:replace="~{layout/footer :: footerStyle}"></th:block>

    <style>
        .post-detail {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .post-detail-header {
            padding: 24px;
            border-bottom: 1px solid #e0e0e0;
        }

        .post-category {
            display: inline-block;
            padding: 4px 12px;
            background-color: #e1bee7;
            color: #6200ea;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .post-detail-title {
            font-size: 24px;
            font-weight: 500;
            color: #212121;
            margin-bottom: 16px;
        }

        .post-detail-meta {
            display: flex;
            gap: 24px;
            font-size: 14px;
            color: #757575;
            flex-wrap: wrap;
        }

        .post-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .post-meta-item .material-icons {
            font-size: 18px;
        }

        .post-detail-stats {
            display: flex;
            gap: 16px;
            padding: 16px 24px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }

        .post-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #757575;
        }

        .post-stat .material-icons {
            font-size: 18px;
        }

        .post-detail-content {
            padding: 32px 24px;
            line-height: 1.8;
            color: #424242;
            font-size: 15px;
        }

        .post-detail-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 16px 0;
        }

        .post-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 24px;
            border-top: 1px solid #e0e0e0;
        }

        .btn {
            padding: 10px 24px;
            border-radius: 4px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-icon {
            padding: 12px 24px;
            background-color: #f5f5f5;
            color: #424242;
            border: 1px solid #e0e0e0;
        }

        .btn-icon:hover {
            background-color: #e0e0e0;
        }

        .btn-icon.active {
            background-color: #e1bee7;
            color: #6200ea;
            border-color: #6200ea;
        }

        .btn .material-icons {
            font-size: 18px;
        }

        .post-nav-actions {
            display: flex;
            justify-content: space-between;
            padding: 24px;
            background-color: #fafafa;
        }

        .btn-secondary {
            background-color: #f5f5f5;
            color: #424242;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        .btn-primary {
            background-color: #6200ea;
            color: white;
        }

        .btn-primary:hover {
            background-color: #5000ca;
        }

        .btn-danger {
            background-color: #d32f2f;
            color: white;
        }

        .btn-danger:hover {
            background-color: #b71c1c;
        }

        .comments-section {
            background: white;
            border-radius: 8px;
            margin-top: 24px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .comments-header {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #212121;
        }

        .comments-header .material-icons {
            color: #6200ea;
        }

        .comment-write {
            margin-bottom: 24px;
        }

        .comment-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            resize: vertical;
            min-height: 80px;
            outline: none;
        }

        .comment-textarea:focus {
            border-color: #6200ea;
        }

        .comment-write-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .comment-list {
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
        }

        .comment-item {
            padding: 16px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .comment-author {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #424242;
        }

        .comment-author .material-icons {
            font-size: 20px;
            color: #757575;
        }

        .comment-date {
            font-size: 12px;
            color: #9e9e9e;
        }

        .comment-content {
            font-size: 14px;
            color: #616161;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .comment-actions {
            display: flex;
            gap: 12px;
        }

        .comment-action-btn {
            background: none;
            border: none;
            padding: 4px 8px;
            font-size: 12px;
            color: #757575;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .comment-action-btn:hover {
            color: #6200ea;
        }

        .comment-action-btn .material-icons {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <th:block th:replace="~{layout/header :: header}"></th:block>

    <main class="main-content">
        <!-- Î°úÎî© ÏÉÅÌÉú -->
        <div id="loadingState" style="display: none; text-align: center; padding: 60px 20px; color: #757575;">
            <div style="font-size: 14px;">Î°úÎî© Ï§ë...</div>
        </div>

        <!-- Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ -->
        <article class="post-detail" id="postDetail" style="display: none;">
            <div class="post-detail-header">
                <h1 class="post-detail-title" id="postTitle"></h1>
                <div class="post-detail-meta">
                    <span class="post-meta-item">
                        <span class="material-icons">person</span>
                        <span id="postAuthor"></span>
                    </span>
                    <span class="post-meta-item">
                        <span class="material-icons">schedule</span>
                        <span id="postDate"></span>
                    </span>
                </div>
            </div>

            <div class="post-detail-stats">
                <span class="post-stat">
                    <span class="material-icons">visibility</span>
                    <span id="postViewCount"></span>
                </span>
            </div>

            <div class="post-detail-content" id="postContent">
                <!-- ÎÇ¥Ïö©Ïù¥ Ïó¨Í∏∞Ïóê Î†åÎçîÎßÅÎê® (ÏóêÎîîÌÑ∞ ÎÇ¥ Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï®) -->
            </div>

            <!-- Ï≤®Î∂ÄÌååÏùº (Îã§Ïö¥Î°úÎìúÎßå) -->
            <div id="postAttachments" style="padding: 0 24px 24px 24px;"></div>

            <div class="post-nav-actions">
                <a href="/community" class="btn btn-secondary">
                    <span class="material-icons">list</span>
                    Î™©Î°ù
                </a>
                <div id="postActions" style="display: none; gap: 8px;">
                    <button class="btn btn-primary" onclick="editPost()">
                        <span class="material-icons">edit</span>
                        ÏàòÏ†ï
                    </button>
                    <button class="btn btn-danger" onclick="deletePost()">
                        <span class="material-icons">delete</span>
                        ÏÇ≠Ï†ú
                    </button>
                </div>
            </div>
        </article>
    </main>

    <th:block th:replace="~{layout/footer :: footer}"></th:block>
    <th:block th:replace="~{layout/header :: headerScript}"></th:block>

    <!-- DOMPurify for XSS Protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <script>
        let currentCommunityId = null;
        let currentUser = null;

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        document.addEventListener('DOMContentLoaded', () => {
            // URLÏóêÏÑú Í≤åÏãúÍ∏Ä ID Ï∂îÏ∂ú
            const urlParams = new URLSearchParams(window.location.search);
            currentCommunityId = urlParams.get('id');

            if (!currentCommunityId) {
                alert('ÏûòÎ™ªÎêú Ï†ëÍ∑ºÏûÖÎãàÎã§.');
                location.href = '/community';
                return;
            }

            checkLoginStatus(); // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏
            loadCommunityDetail(); // Í≤åÏãúÍ∏Ä Î°úÎìú
        });

        // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏
        function checkLoginStatus() {
            fetch('/api/my/info')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Not logged in');
                })
                .then(userInfo => {
                    currentUser = userInfo;
                    console.log('‚úÖ Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú:', userInfo.nickname);
                })
                .catch(err => {
                    console.log('‚ùå ÎπÑÎ°úÍ∑∏Ïù∏ ÏÉÅÌÉú');
                    currentUser = null;
                });
        }

        // Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ Î°úÎìú
        async function loadCommunityDetail() {
            try {
                showLoading(true);

                const response = await fetch(`/api/community/${currentCommunityId}`);

                if (!response.ok) {
                    throw new Error('Í≤åÏãúÍ∏ÄÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }

                const data = await response.json();
                console.log('‚úÖ Í≤åÏãúÍ∏Ä Îç∞Ïù¥ÌÑ∞:', data);

                renderCommunityDetail(data);
                showLoading(false);

            } catch (error) {
                console.error('‚ùå ÏóêÎü¨ Î∞úÏÉù:', error);
                showLoading(false);
                alert('Í≤åÏãúÍ∏ÄÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                location.href = '/community';
            }
        }

        // Í≤åÏãúÍ∏Ä Î†åÎçîÎßÅ
        function renderCommunityDetail(data) {
            // Ï†úÎ™©
            document.getElementById('postTitle').textContent = data.title;

            // ÏûëÏÑ±Ïûê
            document.getElementById('postAuthor').textContent = data.nickname || data.username;

            // ÏûëÏÑ±Ïùº
            document.getElementById('postDate').textContent = formatDate(data.createdAt);

            // Ï°∞ÌöåÏàò
            document.getElementById('postViewCount').textContent = data.viewCount || 0;

            // ÎÇ¥Ïö© (DOMPurifyÎ°ú XSS Î∞©Ïñ¥ Ï≤òÎ¶¨ ÌõÑ Î†åÎçîÎßÅ)
            const cleanContent = DOMPurify.sanitize(data.content, {
                ALLOWED_TAGS: [
                    // ÌÖçÏä§Ìä∏ ÏÑúÏãù
                    'p', 'br', 'strong', 'em', 'u', 's', 'span', 'div',
                    // Ï†úÎ™©
                    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                    // Î™©Î°ù
                    'ul', 'ol', 'li',
                    // Ïù∏Ïö©/ÏΩîÎìú
                    'blockquote', 'pre', 'code',
                    // ÎßÅÌÅ¨
                    'a',
                    // Ïù¥ÎØ∏ÏßÄ (ÏóêÎîîÌÑ∞ÏóêÏÑú ÏÇΩÏûÖÌïú Ïù¥ÎØ∏ÏßÄ)
                    'img'
                ],
                ALLOWED_ATTR: [
                    // Ïä§ÌÉÄÏùº (Quill ÏóêÎîîÌÑ∞ ÏÑúÏãùÏö©)
                    'style', 'class',
                    // ÎßÅÌÅ¨
                    'href', 'target', 'rel',
                    // Ïù¥ÎØ∏ÏßÄ
                    'src', 'alt', 'width', 'height'
                ],
                ALLOW_DATA_ATTR: false, // data-* ÏÜçÏÑ± Ï∞®Îã®
                ALLOW_UNKNOWN_PROTOCOLS: false, // javascript: Í∞ôÏùÄ ÌîÑÎ°úÌÜ†ÏΩú Ï∞®Îã®
            });
            document.getElementById('postContent').innerHTML = cleanContent;

            // Ï≤®Î∂ÄÌååÏùº Î†åÎçîÎßÅ (Îã§Ïö¥Î°úÎìúÎßå Í∞ÄÎä•)
            if (data.attachments && data.attachments.length > 0) {
                const attachmentsHtml = `
                    <div style="border: 1px solid #e0e0e0; border-radius: 4px; padding: 16px; background: #f5f5f5;">
                        <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #424242;">Ï≤®Î∂ÄÌååÏùº</h4>
                        ${data.attachments.map(file => `
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span class="material-icons" style="font-size: 20px; color: #757575;">attach_file</span>
                                <a href="${file.downloadUrl}" style="color: #6200ea; text-decoration: none;" download>
                                    ${file.originalFileName} (${formatFileSize(file.fileSize)})
                                </a>
                            </div>
                        `).join('')}
                    </div>
                `;
                document.getElementById('postAttachments').innerHTML = attachmentsHtml;
            }

            // Î≥∏Ïù∏ Í≤åÏãúÍ∏ÄÏù¥Î©¥ ÏàòÏ†ï/ÏÇ≠Ï†ú Î≤ÑÌäº ÌëúÏãú
            if (currentUser && currentUser.username === data.username) {
                document.getElementById('postActions').style.display = 'flex';
            }

            // Í≤åÏãúÍ∏Ä ÌëúÏãú
            document.getElementById('postDetail').style.display = 'block';
        }

        // Î°úÎî© ÏÉÅÌÉú ÌëúÏãú
        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
            document.getElementById('postDetail').style.display = show ? 'none' : 'block';
        }

        // ÎÇ†Ïßú Ìè¨Îß∑
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ÌååÏùº ÌÅ¨Í∏∞ Ìè¨Îß∑
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ÏàòÏ†ï ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
        function editPost() {
            location.href = `/community/edit?id=${currentCommunityId}`;
        }

        // Í≤åÏãúÍ∏Ä ÏÇ≠Ï†ú
        async function deletePost() {
            if (!confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            try {
                // 1. ÌòÑÏû¨ Í≤åÏãúÍ∏ÄÏùò Ï≤®Î∂ÄÌååÏùº Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞ (Ïù¥ÎØ∏ Î°úÎìúÎêú Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©)
                const response = await fetch(`/api/community/${currentCommunityId}`);
                const data = await response.json();

                // 2. Ï≤®Î∂ÄÌååÏùºÎì§ Î®ºÏ†Ä ÏÇ≠Ï†ú
                if (data.attachments && data.attachments.length > 0) {
                    console.log(`üìé Ï≤®Î∂ÄÌååÏùº ${data.attachments.length}Í∞ú ÏÇ≠Ï†ú Ï§ë...`);
                    for (const file of data.attachments) {
                        try {
                            await fetch(`/api/files/${file.fileId}`, {
                                method: 'DELETE',
                                credentials: 'include'
                            });
                            console.log(`‚úÖ ÌååÏùº ÏÇ≠Ï†ú: ${file.originalFileName}`);
                        } catch (err) {
                            console.warn(`‚ö†Ô∏è ÌååÏùº ÏÇ≠Ï†ú Ïã§Ìå®: ${file.originalFileName}`, err);
                        }
                    }
                }

                // 3. Í≤åÏãúÍ∏Ä ÏÇ≠Ï†ú
                const deleteResponse = await fetch(`/api/community/${currentCommunityId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (deleteResponse.ok || deleteResponse.status === 204) {
                    alert('Í≤åÏãúÍ∏ÄÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    location.href = '/community';
                } else {
                    throw new Error('ÏÇ≠Ï†ú Ïã§Ìå®');
                }
            } catch (error) {
                console.error('‚ùå ÏÇ≠Ï†ú ÏóêÎü¨:', error);
                alert('Í≤åÏãúÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }
    </script>
</body>
</html>

