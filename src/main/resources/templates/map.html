<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸í˜•ë½‘ê¸°ë°© ì •ë³´ - ì§€ë„</title>

    <th:block th:replace="~{layout/header :: headerStyle}"></th:block>
    <th:block th:replace="~{layout/footer :: footerStyle}"></th:block>

    <style>

        /* Region Filter Section */
        .region-filter-section {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-size: 14px;
            font-weight: 500;
            color: #424242;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .filter-select {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            outline: none;
            cursor: pointer;
            background: white;
            min-width: 150px;
            transition: border-color 0.2s;
        }

        .filter-select:hover {
            border-color: #6200ea;
        }

        .filter-select:focus {
            border-color: #6200ea;
            box-shadow: 0 0 0 2px rgba(98, 0, 234, 0.1);
        }


        /* Map specific styles */
        .map-wrapper {
            width: 100%;
            padding: 24px;
            background-color: #fafafa;
        }

        .map-container {
            max-width: 1200px;
            margin: 0 auto;
            height: 540px; /* ê³ ì • ë†’ì´ (600pxì—ì„œ 10% ê°ì†Œ) */
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #map {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }

        .map-controls {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            z-index: 100;
            display: none; /* í•„í„°ê°€ ìœ„ë¡œ ì´ë™í–ˆìœ¼ë¯€ë¡œ ìˆ¨ê¹€ */
            gap: 12px;
            flex-wrap: wrap;
        }

        .search-box {
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            flex: 1;
            min-width: 300px;
        }

        .search-box input {
            border: none;
            outline: none;
            font-size: 14px;
            flex: 1;
            padding: 0;
        }

        .search-box .material-icons {
            color: #757575;
            font-size: 20px;
        }

        .search-box button {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: #6200ea;
        }

        .search-box button:hover {
            color: #3700b3;
        }

        .filter-btn {
            background: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #424242;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background-color: #f5f5f5;
        }

        .filter-btn .material-icons {
            font-size: 20px;
        }

        .map-info {
            margin-top: 24px;
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .map-info h3 {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 16px;
            color: #212121;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .info-card {
            padding: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .info-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .info-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .info-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e1bee7;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6200ea;
        }

        .info-card-icon .material-icons {
            font-size: 24px;
        }

        .info-card h4 {
            font-size: 16px;
            font-weight: 500;
            color: #212121;
        }

        .info-card p {
            font-size: 14px;
            color: #757575;
            line-height: 1.5;
        }

        /* Custom Marker Info Window */
        .custom-infowindow {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 16px;
            min-width: 250px;
        }

        .infowindow-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .infowindow-title {
            font-size: 16px;
            font-weight: 500;
            color: #212121;
            margin-bottom: 4px;
        }

        .infowindow-rating {
            color: #f57c00;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .infowindow-body {
            font-size: 14px;
            color: #757575;
            line-height: 1.6;
        }

        .infowindow-body p {
            margin: 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .infowindow-body .material-icons {
            font-size: 18px;
            color: #9e9e9e;
        }

        .infowindow-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            color: #757575;
            display: flex;
            align-items: center;
        }

        .infowindow-close:hover {
            color: #212121;
        }

        .infowindow-close .material-icons {
            font-size: 20px;
        }

        .infowindow-footer {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
        }

        .infowindow-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .infowindow-btn-primary {
            background-color: #6200ea;
            color: white;
        }

        .infowindow-btn-primary:hover {
            background-color: #3700b3;
        }

        .infowindow-btn-secondary {
            background-color: #f5f5f5;
            color: #424242;
        }

        .infowindow-btn-secondary:hover {
            background-color: #eeeeee;
        }

        .infowindow-btn .material-icons {
            font-size: 16px;
        }

        /* Loading Indicator */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }

        .loading.active {
            display: block;
        }

        @media (max-width: 768px) {
            .filter-container {
                padding: 12px 16px;
            }

            .filter-group {
                flex: 1 1 auto;
            }

            .filter-select {
                min-width: auto;
                flex: 1;
            }


            .map-wrapper {
                padding: 16px;
            }

            .map-container {
                height: 450px;
                border-radius: 4px;
            }
        }
    </style>
</head>
<body>
    <!-- Header Include -->
    <th:block th:replace="~{layout/header :: header}"></th:block>

    <main class="main-content">
        <!-- ì§€ì—­ í•„í„° ì„¹ì…˜ -->
        <div class="region-filter-section">
            <div class="filter-container">
                <div class="filter-group">
                    <label for="sidoSelect">
                        <span class="material-icons" style="font-size: 18px;">location_city</span>
                        ì‹œ/ë„
                    </label>
                    <select id="sidoSelect" class="filter-select" onchange="onSidoChange()">
                        <option value="ì„œìš¸íŠ¹ë³„ì‹œ">ì„œìš¸íŠ¹ë³„ì‹œ</option>
                        <option value="ë¶€ì‚°ê´‘ì—­ì‹œ">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
                        <option value="ëŒ€êµ¬ê´‘ì—­ì‹œ">ëŒ€êµ¬ê´‘ì—­ì‹œ</option>
                        <option value="ì¸ì²œê´‘ì—­ì‹œ">ì¸ì²œê´‘ì—­ì‹œ</option>
                        <option value="ê´‘ì£¼ê´‘ì—­ì‹œ">ê´‘ì£¼ê´‘ì—­ì‹œ</option>
                        <option value="ëŒ€ì „ê´‘ì—­ì‹œ">ëŒ€ì „ê´‘ì—­ì‹œ</option>
                        <option value="ìš¸ì‚°ê´‘ì—­ì‹œ">ìš¸ì‚°ê´‘ì—­ì‹œ</option>
                        <option value="ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ">ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ</option>
                        <option value="ê²½ê¸°ë„">ê²½ê¸°ë„</option>
                        <option value="ê°•ì›íŠ¹ë³„ìì¹˜ë„">ê°•ì›íŠ¹ë³„ìì¹˜ë„</option>
                        <option value="ì¶©ì²­ë¶ë„">ì¶©ì²­ë¶ë„</option>
                        <option value="ì¶©ì²­ë‚¨ë„">ì¶©ì²­ë‚¨ë„</option>
                        <option value="ì „ë¶íŠ¹ë³„ìì¹˜ë„">ì „ë¶íŠ¹ë³„ìì¹˜ë„</option>
                        <option value="ì „ë¼ë‚¨ë„">ì „ë¼ë‚¨ë„</option>
                        <option value="ê²½ìƒë¶ë„">ê²½ìƒë¶ë„</option>
                        <option value="ê²½ìƒë‚¨ë„">ê²½ìƒë‚¨ë„</option>
                        <option value="ì œì£¼íŠ¹ë³„ìì¹˜ë„">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="sigunguSelect">
                        <span class="material-icons" style="font-size: 18px;">place</span>
                        ì‹œ/êµ°/êµ¬
                    </label>
                    <select id="sigunguSelect" class="filter-select" onchange="onSigunguChange()">
                        <option value="">ì „ì²´</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ì§€ë„ ì˜ì—­ -->
        <div class="map-wrapper">
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </main>

<th:block th:replace="~{layout/header :: headerScript}"></th:block>
    <script>
        // Mobile menu toggle
        document.getElementById('mobileMenuBtn')?.addEventListener('click', function() {
            const nav = document.getElementById('headerNav');
            nav.classList.toggle('mobile-open');
        });

        // ì¹´ì¹´ì˜¤ë§µ API ë™ì  ë¡œë“œ
        (function() {
            const kakaoMapKey = '719ae502dd3351fab0a5fa57689ef5cd';
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + kakaoMapKey + '&libraries=services,clusterer&autoload=false';
            script.onload = function() {
                console.log('âœ… ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì„±ê³µ');
            };
            script.onerror = function() {
                console.error('âŒ ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨');
            };
            document.head.appendChild(script);
        })();

        // ì¹´ì¹´ì˜¤ë§µ ê´€ë ¨ ë³€ìˆ˜
        let map;
        let clusterer;
        let markers = [];
        let infowindow;
        let ps; // Places ì„œë¹„ìŠ¤ ê°ì²´
        let allShops = []; // ê²€ìƒ‰ëœ ëª¨ë“  ê°€ê²Œ ì •ë³´
        let currentRegion = 'ì„œìš¸íŠ¹ë³„ì‹œ'; // í˜„ì¬ ì„ íƒëœ ì§€ì—­

        // ì§€ì—­ë³„ ê²€ìƒ‰ ì§€ì  ë§¤í•‘
        const regionSearchPoints = {
            'ì„œìš¸íŠ¹ë³„ì‹œ': [
                { name: 'ê°•ë‚¨1', lat: 37.4979, lng: 127.0276 },
                { name: 'ê°•ë‚¨2', lat: 37.5172, lng: 127.0473 },
                { name: 'ê°•ë‚¨3', lat: 37.4846, lng: 127.0325 },
                { name: 'í™ëŒ€', lat: 37.5563, lng: 126.9244 },
                { name: 'ì‹ ì´Œ', lat: 37.5564, lng: 126.9369 },
                { name: 'ëª…ë™', lat: 37.5636, lng: 126.9834 },
                { name: 'ì ì‹¤', lat: 37.5133, lng: 127.1000 },
                { name: 'ê±´ëŒ€', lat: 37.5402, lng: 127.0695 },
                { name: 'ì´íƒœì›', lat: 37.5345, lng: 126.9949 },
                { name: 'ì¢…ë¡œ', lat: 37.5704, lng: 126.9910 },
                { name: 'ê°•ë¶', lat: 37.6396, lng: 127.0255 },
                { name: 'ì˜ë“±í¬', lat: 37.5264, lng: 126.8962 },
                { name: 'êµ¬ë¡œ', lat: 37.4954, lng: 126.8876 },
                { name: 'ë…¸ì›', lat: 37.6542, lng: 127.0568 },
                { name: 'ì†¡íŒŒ', lat: 37.5145, lng: 127.1059 },
                { name: 'ê°•ë™', lat: 37.5301, lng: 127.1238 },
                { name: 'ë§ˆí¬', lat: 37.5663, lng: 126.9019 },
                { name: 'ìš©ì‚°', lat: 37.5326, lng: 126.9900 },
                { name: 'ì„±ë¶', lat: 37.5894, lng: 127.0167 },
                { name: 'ë™ëŒ€ë¬¸', lat: 37.5744, lng: 127.0395 }
            ],
            'ë¶€ì‚°ê´‘ì—­ì‹œ': [
                { name: 'í•´ìš´ëŒ€', lat: 35.1587, lng: 129.1603 },
                { name: 'ì„œë©´1', lat: 35.1577, lng: 129.0595 },
                { name: 'ì„œë©´2', lat: 35.1541, lng: 129.0631 },
                { name: 'ê´‘ì•ˆë¦¬', lat: 35.1532, lng: 129.1189 },
                { name: 'ë‚¨í¬ë™', lat: 35.0971, lng: 129.0287 },
                { name: 'ë¶€ì‚°ì—­', lat: 35.1156, lng: 129.0403 },
                { name: 'ì„¼í…€', lat: 35.1691, lng: 129.1311 },
                { name: 'ë™ë˜', lat: 35.2048, lng: 129.0785 },
                { name: 'ì‚¬ìƒ', lat: 35.1508, lng: 128.9907 }
            ],
            'ëŒ€êµ¬ê´‘ì—­ì‹œ': [
                { name: 'ë™ì„±ë¡œ', lat: 35.8695, lng: 128.5934 },
                { name: 'ìˆ˜ì„±êµ¬', lat: 35.8242, lng: 128.6308 },
                { name: 'ë‘ë¥˜', lat: 35.8532, lng: 128.5657 },
                { name: 'ì¹ ì„±', lat: 35.8854, lng: 128.5905 }
            ],
            'ì¸ì²œê´‘ì—­ì‹œ': [
                { name: 'ì†¡ë„', lat: 37.3786, lng: 126.6562 },
                { name: 'ë¶€í‰', lat: 37.5077, lng: 126.7236 },
                { name: 'êµ¬ì›”ë™', lat: 37.4454, lng: 126.7052 },
                { name: 'ì£¼ì•ˆ', lat: 37.4638, lng: 126.6791 }
            ],
            'ëŒ€ì „ê´‘ì—­ì‹œ': [
                // ìœ ì„±êµ¬
                { name: 'ìœ ì„±ì˜¨ì²œ', lat: 36.3566, lng: 127.3423 },
                { name: 'ë´‰ëª…ë™', lat: 36.3689, lng: 127.3445 },
                { name: 'ë…¸ì€ë™', lat: 36.3686, lng: 127.3384 },
                { name: 'ì „ë¯¼ë™', lat: 36.3450, lng: 127.3680 },  // ì „ë¯¼ì  ê·¼ì²˜ ì¶”ê°€
                { name: 'ë„ë£¡ë™', lat: 36.3641, lng: 127.3490 },
                { name: 'ê¶ë™', lat: 36.3729, lng: 127.3634 },
                // ì„œêµ¬
                { name: 'ë‘”ì‚°', lat: 36.3504, lng: 127.3845 },
                { name: 'íƒ„ë°©ë™', lat: 36.3450, lng: 127.3748 },
                { name: 'ì›”í‰ë™', lat: 36.3628, lng: 127.3597 },
                // ì¤‘êµ¬
                { name: 'ì€í–‰ë™', lat: 36.3273, lng: 127.4295 },
                { name: 'ëŒ€í¥ë™', lat: 36.3262, lng: 127.4237 },
                // ë™êµ¬
                { name: 'ì‹ ì•ˆë™', lat: 36.3561, lng: 127.4369 },
                // ëŒ€ë•êµ¬
                { name: 'ì¤‘ë¦¬ë™', lat: 36.3693, lng: 127.4147 }
            ],
            'ê´‘ì£¼ê´‘ì—­ì‹œ': [
                { name: 'ì¶©ì¥ë¡œ', lat: 35.1492, lng: 126.9172 },
                { name: 'ìƒë¬´', lat: 35.1520, lng: 126.8533 }
            ],
            'ìš¸ì‚°ê´‘ì—­ì‹œ': [
                { name: 'ì‚¼ì‚°', lat: 35.5372, lng: 129.3390 },
                { name: 'ìš¸ì‚°ì—­', lat: 35.5379, lng: 129.3314 }
            ],
            'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': [
                { name: 'ì„¸ì¢…', lat: 36.4800, lng: 127.2890 }
            ],
            'ê²½ê¸°ë„': [
                { name: 'ìˆ˜ì›1', lat: 37.2661, lng: 127.0015 },
                { name: 'ìˆ˜ì›2', lat: 37.2636, lng: 126.9910 },
                { name: 'ì„±ë‚¨ë¶„ë‹¹', lat: 37.3941, lng: 127.1111 },
                { name: 'ì„±ë‚¨ì¤‘ì›', lat: 37.4201, lng: 127.1262 },
                { name: 'ê³ ì–‘ì¼ì‚°', lat: 37.6638, lng: 126.7684 },
                { name: 'ê³ ì–‘ë•ì–‘', lat: 37.6584, lng: 126.8320 },
                { name: 'ìš©ì¸ê¸°í¥', lat: 37.2767, lng: 127.1163 },
                { name: 'ìš©ì¸ìˆ˜ì§€', lat: 37.3218, lng: 127.0931 },
                { name: 'ë¶€ì²œ', lat: 37.5035, lng: 126.7660 },
                { name: 'ì•ˆì‚°', lat: 37.3219, lng: 126.8309 },
                { name: 'ì•ˆì–‘í‰ì´Œ', lat: 37.3896, lng: 126.9515 },
                { name: 'ì•ˆì–‘ë§Œì•ˆ', lat: 37.3838, lng: 126.9227 },
                { name: 'í‰íƒ', lat: 36.9921, lng: 127.1129 },
                { name: 'ì˜ì •ë¶€', lat: 37.7382, lng: 127.0336 },
                { name: 'ì‹œí¥', lat: 37.3800, lng: 126.8028 },
                { name: 'íŒŒì£¼', lat: 37.7608, lng: 126.7800 },
                { name: 'ê¹€í¬', lat: 37.6152, lng: 126.7157 },
                { name: 'ê´‘ëª…', lat: 37.4786, lng: 126.8644 },
                { name: 'í•˜ë‚¨', lat: 37.5393, lng: 127.2147 }
            ],
            'ê°•ì›íŠ¹ë³„ìì¹˜ë„': [
                { name: 'ì¶˜ì²œ', lat: 37.8813, lng: 127.7298 },
                { name: 'ì›ì£¼', lat: 37.3422, lng: 127.9202 },
                { name: 'ê°•ë¦‰', lat: 37.7519, lng: 128.8761 }
            ],
            'ì¶©ì²­ë¶ë„': [
                { name: 'ì²­ì£¼', lat: 36.6424, lng: 127.4890 }
            ],
            'ì¶©ì²­ë‚¨ë„': [
                { name: 'ì²œì•ˆ', lat: 36.8151, lng: 127.1139 },
                { name: 'ì•„ì‚°', lat: 36.7898, lng: 127.0018 }
            ],
            'ì „ë¶íŠ¹ë³„ìì¹˜ë„': [
                { name: 'ì „ì£¼', lat: 35.8242, lng: 127.1480 },
                { name: 'ìµì‚°', lat: 35.9483, lng: 126.9575 }
            ],
            'ì „ë¼ë‚¨ë„': [
                { name: 'ëª©í¬', lat: 34.8118, lng: 126.3922 },
                { name: 'ìˆœì²œ', lat: 34.9507, lng: 127.4872 },
                { name: 'ì—¬ìˆ˜', lat: 34.7604, lng: 127.6622 }
            ],
            'ê²½ìƒë¶ë„': [
                { name: 'í¬í•­', lat: 36.0190, lng: 129.3435 },
                { name: 'ê²½ì£¼', lat: 35.8562, lng: 129.2247 }
            ],
            'ê²½ìƒë‚¨ë„': [
                { name: 'ì°½ì›', lat: 35.2278, lng: 128.6811 },
                { name: 'ì§„ì£¼', lat: 35.1800, lng: 128.1076 },
                { name: 'ê¹€í•´', lat: 35.2285, lng: 128.8894 },
                { name: 'ê±°ì œ', lat: 34.8806, lng: 128.6211 }
            ],
            'ì œì£¼íŠ¹ë³„ìì¹˜ë„': [
                { name: 'ì œì£¼ì‹œ', lat: 33.4996, lng: 126.5312 },
                { name: 'ì„œê·€í¬', lat: 33.2541, lng: 126.5601 }
            ]
        };

        // ì§€ì—­ë³„ ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ
        const regionCenters = {
            'ì„œìš¸íŠ¹ë³„ì‹œ': { lat: 37.5665, lng: 126.9780, level: 8 },
            'ë¶€ì‚°ê´‘ì—­ì‹œ': { lat: 35.1796, lng: 129.0756, level: 8 },
            'ëŒ€êµ¬ê´‘ì—­ì‹œ': { lat: 35.8714, lng: 128.6014, level: 8 },
            'ì¸ì²œê´‘ì—­ì‹œ': { lat: 37.4563, lng: 126.7052, level: 9 },
            'ê´‘ì£¼ê´‘ì—­ì‹œ': { lat: 35.1595, lng: 126.8526, level: 8 },
            'ëŒ€ì „ê´‘ì—­ì‹œ': { lat: 36.3504, lng: 127.3845, level: 8 },
            'ìš¸ì‚°ê´‘ì—­ì‹œ': { lat: 35.5384, lng: 129.3114, level: 8 },
            'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': { lat: 36.4800, lng: 127.2890, level: 9 },
            'ê²½ê¸°ë„': { lat: 37.4138, lng: 127.5183, level: 10 },
            'ê°•ì›íŠ¹ë³„ìì¹˜ë„': { lat: 37.8228, lng: 128.1555, level: 11 },
            'ì¶©ì²­ë¶ë„': { lat: 36.6424, lng: 127.4890, level: 10 },
            'ì¶©ì²­ë‚¨ë„': { lat: 36.5184, lng: 126.8000, level: 10 },
            'ì „ë¶íŠ¹ë³„ìì¹˜ë„': { lat: 35.7175, lng: 127.1530, level: 10 },
            'ì „ë¼ë‚¨ë„': { lat: 34.8679, lng: 126.9910, level: 10 },
            'ê²½ìƒë¶ë„': { lat: 36.4919, lng: 128.8889, level: 11 },
            'ê²½ìƒë‚¨ë„': { lat: 35.4606, lng: 128.2132, level: 10 },
            'ì œì£¼íŠ¹ë³„ìì¹˜ë„': { lat: 33.4890, lng: 126.4983, level: 10 }
        };

        // ì‹œë„ë³„ ì‹œêµ°êµ¬ ë°ì´í„°
        const sigunguData = {
            'ì„œìš¸íŠ¹ë³„ì‹œ': ['ê°•ë‚¨êµ¬', 'ê°•ë™êµ¬', 'ê°•ë¶êµ¬', 'ê°•ì„œêµ¬', 'ê´€ì•…êµ¬', 'ê´‘ì§„êµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ë™ì‘êµ¬', 'ë§ˆí¬êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ì„œì´ˆêµ¬', 'ì„±ë™êµ¬', 'ì„±ë¶êµ¬', 'ì†¡íŒŒêµ¬', 'ì–‘ì²œêµ¬', 'ì˜ë“±í¬êµ¬', 'ìš©ì‚°êµ¬', 'ì€í‰êµ¬', 'ì¢…ë¡œêµ¬', 'ì¤‘êµ¬', 'ì¤‘ë‘êµ¬'],
            'ë¶€ì‚°ê´‘ì—­ì‹œ': ['ê°•ì„œêµ¬', 'ê¸ˆì •êµ¬', 'ê¸°ì¥êµ°', 'ë‚¨êµ¬', 'ë™êµ¬', 'ë™ë˜êµ¬', 'ë¶€ì‚°ì§„êµ¬', 'ë¶êµ¬', 'ì‚¬ìƒêµ¬', 'ì‚¬í•˜êµ¬', 'ì„œêµ¬', 'ìˆ˜ì˜êµ¬', 'ì—°ì œêµ¬', 'ì˜ë„êµ¬', 'ì¤‘êµ¬', 'í•´ìš´ëŒ€êµ¬'],
            'ëŒ€êµ¬ê´‘ì—­ì‹œ': ['ë‚¨êµ¬', 'ë‹¬ì„œêµ¬', 'ë‹¬ì„±êµ°', 'ë™êµ¬', 'ë¶êµ¬', 'ì„œêµ¬', 'ìˆ˜ì„±êµ¬', 'ì¤‘êµ¬'],
            'ì¸ì²œê´‘ì—­ì‹œ': ['ê°•í™”êµ°', 'ê³„ì–‘êµ¬', 'ë‚¨ë™êµ¬', 'ë™êµ¬', 'ë¯¸ì¶”í™€êµ¬', 'ë¶€í‰êµ¬', 'ì„œêµ¬', 'ì—°ìˆ˜êµ¬', 'ì˜¹ì§„êµ°', 'ì¤‘êµ¬'],
            'ê´‘ì£¼ê´‘ì—­ì‹œ': ['ê´‘ì‚°êµ¬', 'ë‚¨êµ¬', 'ë™êµ¬', 'ë¶êµ¬', 'ì„œêµ¬'],
            'ëŒ€ì „ê´‘ì—­ì‹œ': ['ëŒ€ë•êµ¬', 'ë™êµ¬', 'ì„œêµ¬', 'ìœ ì„±êµ¬', 'ì¤‘êµ¬'],
            'ìš¸ì‚°ê´‘ì—­ì‹œ': ['ë‚¨êµ¬', 'ë™êµ¬', 'ë¶êµ¬', 'ìš¸ì£¼êµ°', 'ì¤‘êµ¬'],
            'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': ['ì„¸ì¢…ì‹œ'],
            'ê²½ê¸°ë„': ['ê°€í‰êµ°', 'ê³ ì–‘ì‹œ', 'ê³¼ì²œì‹œ', 'ê´‘ëª…ì‹œ', 'ê´‘ì£¼ì‹œ', 'êµ¬ë¦¬ì‹œ', 'êµ°í¬ì‹œ', 'ê¹€í¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'ë™ë‘ì²œì‹œ', 'ë¶€ì²œì‹œ', 'ì„±ë‚¨ì‹œ', 'ìˆ˜ì›ì‹œ', 'ì‹œí¥ì‹œ', 'ì•ˆì‚°ì‹œ', 'ì•ˆì„±ì‹œ', 'ì•ˆì–‘ì‹œ', 'ì–‘ì£¼ì‹œ', 'ì–‘í‰êµ°', 'ì—¬ì£¼ì‹œ', 'ì—°ì²œêµ°', 'ì˜¤ì‚°ì‹œ', 'ìš©ì¸ì‹œ', 'ì˜ì™•ì‹œ', 'ì˜ì •ë¶€ì‹œ', 'ì´ì²œì‹œ', 'íŒŒì£¼ì‹œ', 'í‰íƒì‹œ', 'í¬ì²œì‹œ', 'í•˜ë‚¨ì‹œ', 'í™”ì„±ì‹œ'],
            'ê°•ì›íŠ¹ë³„ìì¹˜ë„': ['ê°•ë¦‰ì‹œ', 'ê³ ì„±êµ°', 'ë™í•´ì‹œ', 'ì‚¼ì²™ì‹œ', 'ì†ì´ˆì‹œ', 'ì–‘êµ¬êµ°', 'ì–‘ì–‘êµ°', 'ì˜ì›”êµ°', 'ì›ì£¼ì‹œ', 'ì¸ì œêµ°', 'ì •ì„ êµ°', 'ì² ì›êµ°', 'ì¶˜ì²œì‹œ', 'íƒœë°±ì‹œ', 'í‰ì°½êµ°', 'í™ì²œêµ°', 'í™”ì²œêµ°', 'íš¡ì„±êµ°'],
            'ì¶©ì²­ë¶ë„': ['ê´´ì‚°êµ°', 'ë‹¨ì–‘êµ°', 'ë³´ì€êµ°', 'ì˜ë™êµ°', 'ì˜¥ì²œêµ°', 'ìŒì„±êµ°', 'ì œì²œì‹œ', 'ì¦í‰êµ°', 'ì§„ì²œêµ°', 'ì²­ì£¼ì‹œ', 'ì¶©ì£¼ì‹œ'],
            'ì¶©ì²­ë‚¨ë„': ['ê³„ë£¡ì‹œ', 'ê³µì£¼ì‹œ', 'ê¸ˆì‚°êµ°', 'ë…¼ì‚°ì‹œ', 'ë‹¹ì§„ì‹œ', 'ë³´ë ¹ì‹œ', 'ë¶€ì—¬êµ°', 'ì„œì‚°ì‹œ', 'ì„œì²œêµ°', 'ì•„ì‚°ì‹œ', 'ì˜ˆì‚°êµ°', 'ì²œì•ˆì‹œ', 'ì²­ì–‘êµ°', 'íƒœì•ˆêµ°', 'í™ì„±êµ°'],
            'ì „ë¶íŠ¹ë³„ìì¹˜ë„': ['ê³ ì°½êµ°', 'êµ°ì‚°ì‹œ', 'ê¹€ì œì‹œ', 'ë‚¨ì›ì‹œ', 'ë¬´ì£¼êµ°', 'ë¶€ì•ˆêµ°', 'ìˆœì°½êµ°', 'ì™„ì£¼êµ°', 'ìµì‚°ì‹œ', 'ì„ì‹¤êµ°', 'ì¥ìˆ˜êµ°', 'ì „ì£¼ì‹œ', 'ì •ìì‹œ', 'ì§„ì•ˆêµ°'],
            'ì „ë¼ë‚¨ë„': ['ê°•ì§„êµ°', 'ê³ í¥êµ°', 'ê³¡ì„±êµ°', 'ê´‘ì–‘ì‹œ', 'êµ¬ë¡€êµ°', 'ë‚˜ì£¼ì‹œ', 'ë‹´ì–‘êµ°', 'ëª©í¬ì‹œ', 'ë¬´ì•ˆêµ°', 'ë³´ì„±êµ°', 'ìˆœì²œì‹œ', 'ì‹ ì•ˆêµ°', 'ì—¬ìˆ˜ì‹œ', 'ì˜ê´‘êµ°', 'ì˜ì•”êµ°', 'ì™„ë„êµ°', 'ì¥ì„±êµ°', 'ì¥í¥êµ°', 'ì§„ë„êµ°', 'í•¨í‰êµ°', 'í•´ë‚¨êµ°', 'í™”ìˆœêµ°'],
            'ê²½ìƒë¶ë„': ['ê²½ì‚°ì‹œ', 'ê²½ì£¼ì‹œ', 'ê³ ë ¹êµ°', 'êµ¬ë¯¸ì‹œ', 'êµ°ìœ„êµ°', 'ê¹€ì²œì‹œ', 'ë¬¸ê²½ì‹œ', 'ë´‰í™”êµ°', 'ìƒì£¼ì‹œ', 'ì„±ì£¼êµ°', 'ì•ˆë™ì‹œ', 'ì˜ë•êµ°', 'ì˜ì–‘êµ°', 'ì˜ì£¼ì‹œ', 'ì˜ì²œì‹œ', 'ì˜ˆì²œêµ°', 'ìš¸ë¦‰êµ°', 'ìš¸ì§„êµ°', 'ì˜ì„±êµ°', 'ì²­ë„êµ°', 'ì²­ì†¡êµ°', 'ì¹ ê³¡êµ°', 'í¬í•­ì‹œ'],
            'ê²½ìƒë‚¨ë„': ['ê±°ì œì‹œ', 'ê±°ì°½êµ°', 'ê³ ì„±êµ°', 'ê¹€í•´ì‹œ', 'ë‚¨í•´êµ°', 'ë°€ì–‘ì‹œ', 'ì‚¬ì²œì‹œ', 'ì‚°ì²­êµ°', 'ì–‘ì‚°ì‹œ', 'ì˜ë ¹êµ°', 'ì§„ì£¼ì‹œ', 'ì°½ë…•êµ°', 'ì°½ì›ì‹œ', 'í†µì˜ì‹œ', 'í•˜ë™êµ°', 'í•¨ì•ˆêµ°', 'í•¨ì–‘êµ°', 'í•©ì²œêµ°'],
            'ì œì£¼íŠ¹ë³„ìì¹˜ë„': ['ì„œê·€í¬ì‹œ', 'ì œì£¼ì‹œ']
        };

        // ì‹œêµ°êµ¬ë³„ ì¤‘ì‹¬ ì¢Œí‘œ (ì£¼ìš” ê´‘ì—­ì‹œ)
        const sigunguCenters = {
            // ëŒ€ì „ê´‘ì—­ì‹œ
            'ëŒ€ì „ê´‘ì—­ì‹œ-ëŒ€ë•êµ¬': { lat: 36.3693, lng: 127.4147, level: 7 },
            'ëŒ€ì „ê´‘ì—­ì‹œ-ë™êµ¬': { lat: 36.3393, lng: 127.4458, level: 7 },
            'ëŒ€ì „ê´‘ì—­ì‹œ-ì„œêµ¬': { lat: 36.3504, lng: 127.3845, level: 7 },
            'ëŒ€ì „ê´‘ì—­ì‹œ-ìœ ì„±êµ¬': { lat: 36.3566, lng: 127.3423, level: 7 },
            'ëŒ€ì „ê´‘ì—­ì‹œ-ì¤‘êµ¬': { lat: 36.3273, lng: 127.4295, level: 7 },
            // ì„œìš¸íŠ¹ë³„ì‹œ (ì£¼ìš” êµ¬)
            'ì„œìš¸íŠ¹ë³„ì‹œ-ê°•ë‚¨êµ¬': { lat: 37.5172, lng: 127.0473, level: 7 },
            'ì„œìš¸íŠ¹ë³„ì‹œ-ê°•ì„œêµ¬': { lat: 37.5509, lng: 126.8495, level: 7 },
            'ì„œìš¸íŠ¹ë³„ì‹œ-ì†¡íŒŒêµ¬': { lat: 37.5145, lng: 127.1059, level: 7 },
            'ì„œìš¸íŠ¹ë³„ì‹œ-ë§ˆí¬êµ¬': { lat: 37.5663, lng: 126.9019, level: 7 },
            // ë¶€ì‚°ê´‘ì—­ì‹œ
            'ë¶€ì‚°ê´‘ì—­ì‹œ-í•´ìš´ëŒ€êµ¬': { lat: 35.1587, lng: 129.1603, level: 7 },
            'ë¶€ì‚°ê´‘ì—­ì‹œ-ë¶€ì‚°ì§„êµ¬': { lat: 35.1577, lng: 129.0595, level: 7 },
            'ë¶€ì‚°ê´‘ì—­ì‹œ-ë‚¨êµ¬': { lat: 35.1363, lng: 129.0847, level: 7 },
            'ë¶€ì‚°ê´‘ì—­ì‹œ-ë™ë˜êµ¬': { lat: 35.2048, lng: 129.0785, level: 7 }
        };

        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ ì¤‘ì‹¬
                level: 8 // ì„œìš¸ ì „ì²´ê°€ ë³´ì´ëŠ” ë ˆë²¨
            };

            map = new kakao.maps.Map(container, options);
            infowindow = new kakao.maps.InfoWindow({zIndex: 1});
            ps = new kakao.maps.services.Places();

            // ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ëŸ¬ ì´ˆê¸°í™”
            clusterer = new kakao.maps.MarkerClusterer({
                map: map,
                averageCenter: true,
                minLevel: 5,
                calculator: [10, 30, 50],
                styles: [{
                    width: '50px',
                    height: '50px',
                    background: '#6200ea',
                    borderRadius: '25px',
                    color: '#fff',
                    textAlign: 'center',
                    lineHeight: '50px',
                    fontSize: '14px',
                    fontWeight: 'bold',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.3)'
                }, {
                    width: '60px',
                    height: '60px',
                    background: '#3700b3',
                    borderRadius: '30px',
                    color: '#fff',
                    textAlign: 'center',
                    lineHeight: '60px',
                    fontSize: '16px',
                    fontWeight: 'bold',
                    boxShadow: '0 2px 6px rgba(0,0,0,0.3)'
                }, {
                    width: '70px',
                    height: '70px',
                    background: '#1a0052',
                    borderRadius: '35px',
                    color: '#fff',
                    textAlign: 'center',
                    lineHeight: '70px',
                    fontSize: '18px',
                    fontWeight: 'bold',
                    boxShadow: '0 3px 8px rgba(0,0,0,0.3)'
                }]
            });


            // ê¸°ë³¸ ì§€ì—­(ì„œìš¸) ì‹œêµ°êµ¬ ëª©ë¡ ì´ˆê¸°í™”
            updateSigunguSelect('ì„œìš¸íŠ¹ë³„ì‹œ');

            // ê¸°ë³¸ ì§€ì—­(ì„œìš¸) ì¸í˜•ë½‘ê¸° ê°€ê²Œ ê²€ìƒ‰
            searchDollCatcherShops('ì„œìš¸íŠ¹ë³„ì‹œ');
        }

        // ê²€ìƒ‰ ìƒíƒœ ë³€ìˆ˜
        let searchState = {
            sido: '',
            sigungu: null
        };

        // ì¸í˜•ë½‘ê¸° ê°€ê²Œ ê²€ìƒ‰ (DBì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        function searchDollCatcherShops(region, sigungu = null) {
            currentRegion = sigungu ? `${region} ${sigungu}` : region;
            const displayText = sigungu ? `${region} ${sigungu}` : region;
            console.log(`ğŸ” ${displayText} ë°ì´í„° ë¡œë”© ì¤‘...`);

            // ê²€ìƒ‰ ìƒíƒœ ì„¤ì •
            searchState = {
                sido: region,
                sigungu: sigungu
            };

            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            clusterer.clear();
            markers = [];
            allShops = [];

            // ì§€ë„ ì¤‘ì‹¬ ì´ë™
            let centerCoords;
            if (sigungu) {
                // ì‹œêµ°êµ¬ ì„ íƒ ì‹œ í•´ë‹¹ êµ¬ì˜ ì¤‘ì‹¬ì¢Œí‘œ ì‚¬ìš©
                const sigunguKey = `${region}-${sigungu}`;
                centerCoords = sigunguCenters[sigunguKey] || regionCenters[region];
            } else {
                // ì‹œë„ë§Œ ì„ íƒ ì‹œ ì‹œë„ ì¤‘ì‹¬ì¢Œí‘œ ì‚¬ìš©
                centerCoords = regionCenters[region];
            }

            if (centerCoords) {
                map.setCenter(new kakao.maps.LatLng(centerCoords.lat, centerCoords.lng));
                map.setLevel(centerCoords.level);
            }

            // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            let apiUrl = `/api/doll-shops/map?gubun1=${encodeURIComponent(region)}`;
            if (sigungu) {
                // ì‹œêµ°êµ¬ê¹Œì§€ ì§€ì •ëœ ê²½ìš°
                apiUrl += `&gubun2=${encodeURIComponent(sigungu)}`;
            }

            console.log(`ğŸ” ì„œë²„ì—ì„œ ë°ì´í„° ë¡œë”©: ${displayText}`);

            fetch(apiUrl)
                .then(async response => {
                    if (!response.ok) {
                        const error = await handleApiError(response);
                        throw error;
                    }
                    return response.json();
                })
                .then(result => {
                    const shops = result.data; // ApiResponseì—ì„œ data ì¶”ì¶œ
                    if (!Array.isArray(shops)) {
                        console.error("ì‘ë‹µ ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:", shops);
                        return;
                    }
                    console.log(`âœ… ${shops.length}ê°œ ê°€ê²Œ ë¡œë“œ ì™„ë£Œ`);

                    // ë°ì´í„°ë¥¼ allShopsì— ì €ì¥í•˜ê³  ë§ˆì»¤ ìƒì„±
                    shops.forEach(shop => {
                        // DB í˜•ì‹ì„ ì¹´ì¹´ì˜¤ë§µ API í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                        const place = {
                            id: shop.id,
                            place_name: shop.businessName,
                            address_name: shop.address,
                            road_address_name: shop.address,
                            phone: shop.phone || '',
                            x: shop.longitude,
                            y: shop.latitude,
                            totalGameMachines: shop.totalGameMachines,
                            approvalDate: shop.approvalDate,
                            isOperating: shop.isOperating
                        };

                        allShops.push(place);

                        const position = new kakao.maps.LatLng(place.y, place.x);
                        const marker = new kakao.maps.Marker({
                            position: position,
                            title: place.place_name
                        });

                        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                        kakao.maps.event.addListener(marker, 'click', function() {
                            displayKakaoPlaceInfo(place, marker);
                        });

                        markers.push(marker);
                    });

                    // ë§ˆì»¤ë¥¼ í´ëŸ¬ìŠ¤í„°ëŸ¬ì— ì¶”ê°€
                    clusterer.addMarkers(markers);

                    console.log(`âœ… ê²€ìƒ‰ ì™„ë£Œ!`);
                    console.log(`- ì´ ${allShops.length}ê°œì˜ ì¸í˜•ë½‘ê¸° ê°€ê²Œ í‘œì‹œ`);
                })
                .catch(error => {
                    console.error('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    if (error.message) {
                        alert(error.message);
                    }
                });
        }


        // ì¹´ì¹´ì˜¤ Places API ì¥ì†Œ ì •ë³´ í‘œì‹œ
        function displayKakaoPlaceInfo(place, marker) {
            const content = `
                <div class="custom-infowindow">
                    <div class="infowindow-header">
                        <div>
                            <div class="infowindow-title">${place.place_name}</div>
                            <div class="infowindow-rating" style="color: #757575; font-size: 13px;">
                                ${place.totalGameMachines ? 'ì´ ê¸°ê³„ ìˆ˜: ' + place.totalGameMachines + 'ëŒ€' : ''}
                            </div>
                        </div>
                        <button class="infowindow-close" onclick="closeInfowindow()">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div class="infowindow-body">
                        <p>
                            <span class="material-icons">location_on</span>
                            ${place.address_name || place.road_address_name}
                        </p>
                        ${place.phone ? `
                        <p>
                            <span class="material-icons">phone</span>
                            ${place.phone}
                        </p>
                        ` : ''}
                    </div>
                    <div class="infowindow-footer">
                        <button class="infowindow-btn infowindow-btn-primary" onclick="location.href='/doll-shop/detail?id=${place.id}'">
                            <span class="material-icons">info</span>
                            ìƒì„¸ë³´ê¸°
                        </button>
                        <button class="infowindow-btn infowindow-btn-secondary" onclick="getDirections(${place.y}, ${place.x})">
                            <span class="material-icons">directions</span>
                            ê¸¸ì°¾ê¸°
                        </button>
                    </div>
                </div>
            `;

            infowindow.setContent(content);
            infowindow.open(map, marker);
        }

        // ì¸í¬ìœˆë„ìš° ë‹«ê¸°
        function closeInfowindow() {
            infowindow.close();
        }

        // ì¹´ì¹´ì˜¤ë§µ ìƒì„¸ë³´ê¸° ì—´ê¸°
        function openKakaoPlace(url) {
            window.open(url, '_blank');
        }

        // ê¸¸ì°¾ê¸°
        function getDirections(lat, lng) {
            const kakaoMapUrl = `https://map.kakao.com/link/to/ëª©ì ì§€,${lat},${lng}`;
            window.open(kakaoMapUrl, '_blank');
        }

        // ì‹œë„ ë³€ê²½ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        function onSidoChange() {
            const selectedSido = document.getElementById('sidoSelect').value;
            console.log(`ğŸ—ºï¸ ì‹œë„ ë³€ê²½: ${selectedSido}`);

            // ì‹œêµ°êµ¬ ì…€ë ‰íŠ¸ë°•ìŠ¤ ì—…ë°ì´íŠ¸
            updateSigunguSelect(selectedSido);

            // ì „ì²´ ì‹œë„ ê²€ìƒ‰
            searchDollCatcherShops(selectedSido);
        }

        // ì‹œêµ°êµ¬ ì…€ë ‰íŠ¸ë°•ìŠ¤ ì—…ë°ì´íŠ¸
        function updateSigunguSelect(sido) {
            const sigunguSelect = document.getElementById('sigunguSelect');
            sigunguSelect.innerHTML = '<option value="">ì „ì²´</option>';

            const sigungus = sigunguData[sido] || [];
            sigungus.forEach(sigungu => {
                const option = document.createElement('option');
                option.value = sigungu;
                option.textContent = sigungu;
                sigunguSelect.appendChild(option);
            });
        }

        // ì‹œêµ°êµ¬ ë³€ê²½ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        function onSigunguChange() {
            const selectedSido = document.getElementById('sidoSelect').value;
            const selectedSigungu = document.getElementById('sigunguSelect').value;

            if (selectedSigungu) {
                console.log(`ğŸ—ºï¸ ì‹œêµ°êµ¬ ë³€ê²½: ${selectedSido} ${selectedSigungu}`);
                // TODO: ì‹œêµ°êµ¬ë³„ í•„í„°ë§ (ì¶”í›„ êµ¬í˜„)
                searchDollCatcherShopsBySigungu(selectedSido, selectedSigungu);
            } else {
                console.log(`ğŸ—ºï¸ ì „ì²´ ì„ íƒ: ${selectedSido}`);
                searchDollCatcherShops(selectedSido);
            }
        }

        // ì‹œêµ°êµ¬ë³„ ê²€ìƒ‰
        function searchDollCatcherShopsBySigungu(sido, sigungu) {
            currentRegion = `${sido} ${sigungu}`;
            console.log(`ğŸ” ${sido} ${sigungu} ê²€ìƒ‰ ì‹œì‘`);

            // ì‹œêµ°êµ¬ê¹Œì§€ ì§€ì •í•˜ì—¬ ê²€ìƒ‰
            searchDollCatcherShops(sido, sigungu);
        }

        // ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ í™•ì¸ ë° ì´ˆê¸°í™”
        let kakaoLoadAttempts = 0;
        const maxAttempts = 100; // ìµœëŒ€ 10ì´ˆ ëŒ€ê¸°

        function waitForKakao() {
            kakaoLoadAttempts++;

            if (window.kakao && window.kakao.maps) {
                console.log('âœ… ì¹´ì¹´ì˜¤ë§µ API ê°ì²´ í™•ì¸ ì™„ë£Œ');
                try {
                    // autoload=falseë¥¼ ì‚¬ìš©í–ˆìœ¼ë¯€ë¡œ ëª…ì‹œì ìœ¼ë¡œ load í˜¸ì¶œ
                    kakao.maps.load(() => {
                        console.log('âœ… ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì‹œì‘');
                        initMap();
                    });
                } catch(e) {
                    console.error('âŒ ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
                    document.getElementById('shopCount').textContent = 'ì§€ë„ ë¡œë”© ì‹¤íŒ¨: ' + e.message;
                }
            } else if (kakaoLoadAttempts >= maxAttempts) {
                console.error('âŒ ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì‹¤íŒ¨ (íƒ€ì„ì•„ì›ƒ)');
                console.log('window.kakao:', window.kakao);
                document.getElementById('shopCount').textContent = 'ì¹´ì¹´ì˜¤ë§µ API íƒ€ì„ì•„ì›ƒ. í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
            } else {
                if (kakaoLoadAttempts % 10 === 0) {
                    console.log(`â³ ì¹´ì¹´ì˜¤ë§µ API ëŒ€ê¸° ì¤‘... (${kakaoLoadAttempts}/${maxAttempts})`);
                }
                setTimeout(waitForKakao, 100);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        setTimeout(waitForKakao, 500); // 0.5ì´ˆ í›„ ì‹œì‘
    </script>

    <th:block th:replace="~{layout/footer :: footer}"></th:block>
</body>
</html>

