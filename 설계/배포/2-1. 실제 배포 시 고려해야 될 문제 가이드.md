# ì‹¤ì œ ë°°í¬ ì‹œ ê³ ë ¤í•´ì•¼ ë  ë¬¸ì œ ê°€ì´ë“œ

## ğŸ“Œ í”„ë¡œì íŠ¸ êµ¬ì¡° ìš”ì•½

### ê¸°ìˆ  ìŠ¤íƒ
- **Backend**: Spring Boot 3.3.4, Java 17
- **Database**: MariaDB 10.11
- **ì¸ì¦**: JWT + OAuth2 (ì¹´ì¹´ì˜¤, êµ¬ê¸€)
- **ORM**: JPA + QueryDSL
- **í…œí”Œë¦¿**: Thymeleaf (SSR + CSR í˜¼í•©)
- **ë¹Œë“œ**: Gradle
- **ë°°í¬**: Docker + Railway (2ë²ˆ ë°©ì‹: Railwayê°€ GitHub repoë¡œ Docker ì´ë¯¸ì§€ ë¹Œë“œ + ì‹¤í–‰)

### ì£¼ìš” ë„ë©”ì¸
| ë„ë©”ì¸ | ì„¤ëª… |
|--------|------|
| `jwt` | ì¸ì¦/ì¸ê°€ (JWT, OAuth2, Security) |
| `dollshop` | ì¸í˜•ë½‘ê¸° ê°€ê²Œ ì •ë³´ |
| `review` | ê°€ê²Œ ë¦¬ë·° |
| `community` | ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œíŒ |
| `comment` | ëŒ“ê¸€ |
| `file` | íŒŒì¼ ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œ |

---

## ğŸš¨ ë°°í¬ í™˜ê²½ì—ì„œ í™•ì¸í•´ì•¼ í•  ë¬¸ì œë“¤

### 1. í™˜ê²½ë³€ìˆ˜ ì„¤ì • (Railway Variables)

Railwayì—ì„œ ë°˜ë“œì‹œ ì„¤ì •í•´ì•¼ í•˜ëŠ” í™˜ê²½ë³€ìˆ˜:

```
# ë°ì´í„°ë² ì´ìŠ¤ (Railway MySQL ìë™ ìƒì„± ì‹œ ì œê³µ)
SPRING_DATASOURCE_URL=jdbc:mariadb://xxxxx:3306/doll_gacha
SPRING_DATASOURCE_USERNAME=xxxxx
SPRING_DATASOURCE_PASSWORD=xxxxx

# OAuth2 (ì¹´ì¹´ì˜¤/êµ¬ê¸€ ê°œë°œì ì½˜ì†”ì—ì„œ ë°œê¸‰)
KAKAO_CLIENT_ID=xxxxx
KAKAO_CLIENT_SECRET=xxxxx
GOOGLE_CLIENT_ID=xxxxx
GOOGLE_CLIENT_SECRET=xxxxx

# JWT
JWT_SECRET_KEY=xxxxx (ìµœì†Œ 32ì ì´ìƒ ê¶Œì¥)

# ì•± ê¸°ë³¸ URL (Railway ë°°í¬ URL)
APP_BASE_URL=https://dollgacha-production.up.railway.app
```

**âš ï¸ ì²´í¬í¬ì¸íŠ¸:**
- `.env` íŒŒì¼ì€ ë¡œì»¬ìš©. Railwayì—ì„œëŠ” Variables íƒ­ì—ì„œ ì„¤ì •
- `spring-dotenv` ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ `.env` íŒŒì¼ ì½ìŒ (ë¡œì»¬ë§Œ)

---

### 2. OAuth2 Redirect URI ë¬¸ì œ â­â­â­

**ê°€ì¥ í”í•œ ë°°í¬ ì˜¤ë¥˜!**

#### í˜„ì¬ ì„¤ì • (application-prod.yml)
```yaml
redirect-uri: ${APP_BASE_URL:http://localhost:8080}/login/oauth2/code/kakao
redirect-uri: ${APP_BASE_URL:http://localhost:8080}/login/oauth2/code/google
```

#### í•´ì•¼ í•  ì¼
1. **ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†”** (https://developers.kakao.com)
   - ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ â†’ ì•± ì„¤ì • â†’ í”Œë«í¼ â†’ Web
   - **ì‚¬ì´íŠ¸ ë„ë©”ì¸**: `https://dollgacha-production.up.railway.app`
   - ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ â†’ Redirect URI ì¶”ê°€:
     - `https://dollgacha-production.up.railway.app/login/oauth2/code/kakao`

2. **êµ¬ê¸€ Cloud Console** (https://console.cloud.google.com)
   - API ë° ì„œë¹„ìŠ¤ â†’ ì‚¬ìš©ì ì¸ì¦ ì •ë³´ â†’ OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID
   - **ìŠ¹ì¸ëœ JavaScript ì›ë³¸**: `https://dollgacha-production.up.railway.app`
   - **ìŠ¹ì¸ëœ ë¦¬ë””ë ‰ì…˜ URI**: 
     - `https://dollgacha-production.up.railway.app/login/oauth2/code/google`

---

### 3. CORS ì„¤ì • (CorsConfig.java) - âœ… ìˆ˜ì • ì™„ë£Œ

#### ë¬¸ì œ ìƒí™©
```
Login error: SyntaxError: Unexpected token 'I', "Invalid CORS request" is not valid JSON
```

---

#### ğŸ” ë¬¸ì œ ë°œìƒ ì›ì¸ ìƒì„¸ ë¶„ì„

##### 1. Springì—ì„œ CORS ì²˜ë¦¬í•˜ëŠ” 2ê°€ì§€ ë°©ë²•

| ë°©ë²• | ë™ì‘ ìœ„ì¹˜ | Security ì¸ì‹ |
|------|----------|--------------|
| `WebMvcConfigurer` | DispatcherServlet (ëŠ¦ìŒ) | âŒ |
| `CorsConfigurationSource` Bean | Security Filter (ë¹ ë¦„) | âœ… |

##### 2. ìš”ì²­ ì²˜ë¦¬ ìˆœì„œ
```
ìš”ì²­ â†’ [Security í•„í„° ì²´ì¸] â†’ [DispatcherServlet] â†’ Controller
              â†‘                        â†‘
        CorsFilter ì—¬ê¸°!         WebMvcConfigurer ì—¬ê¸°!
        (ë¨¼ì € ì‹¤í–‰ë¨)            (ë„ˆë¬´ ëŠ¦ìŒ)
```

##### 3. `cors(Customizer.withDefaults())`ì˜ ë™ì‘
```java
// SecurityConfig.java
http.cors(Customizer.withDefaults())
```
- **CorsFilterë¥¼ Security í•„í„° ì²´ì¸ì— ì¶”ê°€**
- **CorsConfigurationSource Beanì„ ì°¾ì•„ì„œ ì‚¬ìš©**
- **Beanì´ ì—†ìœ¼ë©´ â†’ ê¸°ë³¸ ì„¤ì • ì‚¬ìš© (ëª¨ë“  ìš”ì²­ ê±°ë¶€!)**

##### 4. ê¸°ì¡´ ì„¤ì •ì˜ ë¬¸ì œ
```
[SecurityConfig]
  â””â”€â”€ cors(Customizer.withDefaults())  
        â””â”€â”€ CorsConfigurationSource Bean ì°¾ê¸°
              â””â”€â”€ ì—†ìŒ! âŒ (WebMvcConfigurerëŠ” Beanì´ ì•„ë‹˜)
                    â””â”€â”€ "Invalid CORS request" ì—ëŸ¬!

[CorsConfig implements WebMvcConfigurer]  
  â””â”€â”€ DispatcherServletì— ë“±ë¡ë¨
        â””â”€â”€ Security í•„í„° ì´í›„ì— ë™ì‘ â†’ ì´ë¯¸ ê±°ë¶€ë‹¹í•¨! ğŸš«
```

##### 5. ê°™ì€ ë„ë©”ì¸ì¸ë° ì™œ CORS ì²´í¬?
- **ë¸Œë¼ìš°ì € CORS**: ê°™ì€ Originì´ë©´ CORS í—¤ë” ì•ˆ ë³´ëƒ„ âœ…
- **Spring CorsFilter**: ìš”ì²­ ë“¤ì–´ì˜¤ë©´ ë¬´ì¡°ê±´ ì„¤ì • í™•ì¸ â†’ ì—†ìœ¼ë©´ ê±°ë¶€!
- **"Invalid CORS request"ëŠ” ë¸Œë¼ìš°ì € ì—ëŸ¬ê°€ ì•„ë‹ˆë¼ ì„œë²„ ì¸¡ í•„í„°ì˜ ê±°ë¶€!**

---

#### í•´ê²° ë°©ë²• (ì ìš©ë¨ âœ…)
`CorsConfigurationSource` Beanìœ¼ë¡œ ë³€ê²½:
```java
@Bean
public CorsConfigurationSource corsConfigurationSource() {
    CorsConfiguration configuration = new CorsConfiguration();
    configuration.setAllowedOrigins(Arrays.asList(
        "http://localhost:3000",
        "http://localhost:5173",
        "http://localhost:8080",
        "https://dollgacha-production.up.railway.app"  // ìš´ì˜ ë„ë©”ì¸ ì¶”ê°€
    ));
    configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"));
    configuration.setAllowedHeaders(List.of("*"));
    configuration.setAllowCredentials(true);
    
    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
    source.registerCorsConfiguration("/**", configuration);
    return source;
}
```

#### í•µì‹¬ ê²°ë¡ 
```
Spring Securityì—ì„œ cors(Customizer.withDefaults()) ì‚¬ìš© ì‹œ
â†’ ë°˜ë“œì‹œ CorsConfigurationSource Bean ë“±ë¡ í•„ìˆ˜!
â†’ WebMvcConfigurer ë°©ì‹ì€ Security í•„í„°ë³´ë‹¤ ëŠ¦ê²Œ ë™ì‘í•´ì„œ ë¬´ìš©ì§€ë¬¼!
```

---

### 4. ì¿ í‚¤ Secure ì„¤ì • (OAuth2LoginSuccessHandler.java)

í˜„ì¬:
```java
.secure(false) // ìš´ì˜ í™˜ê²½(HTTPS)ì—ì„œëŠ” true ê¶Œì¥
```

#### ìˆ˜ì • í•„ìš” (ìš´ì˜ HTTPS í™˜ê²½)
```java
.secure(true)  // HTTPS í™˜ê²½ì—ì„œë§Œ ì¿ í‚¤ ì „ì†¡
.sameSite("None")  // í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ì—ì„œ ì¿ í‚¤ ì‚¬ìš© ì‹œ í•„ìš”
```

**ë˜ëŠ” í™˜ê²½ë³„ ë¶„ê¸°:**
```java
@Value("${app.secure-cookie:false}")
private boolean secureCookie;

// ì‚¬ìš© ì‹œ
.secure(secureCookie)
```

---

### 5. íŒŒì¼ ì—…ë¡œë“œ ê²½ë¡œ â­â­

#### í˜„ì¬ ì„¤ì •
| í™˜ê²½ | ê²½ë¡œ |
|------|------|
| ë¡œì»¬ (application.yml) | `C:/workspace/simple_side/doll_gacha/uploads` |
| ìš´ì˜ (application-prod.yml) | `/app/uploads` |

#### Dockerfile í™•ì¸
```dockerfile
RUN mkdir -p /app/uploads  # ë””ë ‰í† ë¦¬ ìƒì„±ë¨ âœ…
```

**âš ï¸ ë¬¸ì œì : RailwayëŠ” Ephemeral Storage (íœ˜ë°œì„± ìŠ¤í† ë¦¬ì§€)**
- ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘/ì¬ë°°í¬ ì‹œ **ì—…ë¡œë“œëœ íŒŒì¼ì´ ëª¨ë‘ ì‚­ì œë¨**

#### í•´ê²° ë°©ì•ˆ
1. **ì™¸ë¶€ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©** (ê¶Œì¥)
   - AWS S3, Cloudinary, Railway Volume ë“±
   
2. **Railway Volume ë§ˆìš´íŠ¸**
   - Railway ëŒ€ì‹œë³´ë“œì—ì„œ Volume ìƒì„± â†’ `/app/uploads`ì— ë§ˆìš´íŠ¸

3. **í˜„ì¬ ì—°ìŠµìš©ì´ë¼ë©´**
   - `ddl-auto: create`ì™€ `sql.init.mode: always`ë¡œ ë§¤ë²ˆ ì´ˆê¸° ë°ì´í„° ìƒì„±ë¨
   - ì—…ë¡œë“œ íŒŒì¼ ìœ ì‹¤ ê°ìˆ˜í•˜ê³  ì§„í–‰

---

### 6. ë°ì´í„°ë² ì´ìŠ¤ DDL ì „ëµ

#### í˜„ì¬ ì„¤ì • (application-prod.yml)
```yaml
jpa:
  hibernate:
    ddl-auto: create  # ì—°ìŠµìš©: ë§¤ë²ˆ í…Œì´ë¸” ìƒˆë¡œ ìƒì„±
```

**âš ï¸ ìš´ì˜ì—ì„œ `create` ì‚¬ìš© ì‹œ:**
- ë°°í¬í•  ë•Œë§ˆë‹¤ **ëª¨ë“  ë°ì´í„° ì‚­ì œ**
- ì—°ìŠµ/ë°ëª¨ìš©ì€ OK, ì‹¤ì œ ì„œë¹„ìŠ¤ëŠ” `validate` ë˜ëŠ” `none` ì‚¬ìš©

#### ê¶Œì¥ ì„¤ì • (ì‹¤ì œ ìš´ì˜)
```yaml
ddl-auto: validate  # ìŠ¤í‚¤ë§ˆ ê²€ì¦ë§Œ (ë³€ê²½ ì—†ìŒ)
# ë˜ëŠ”
ddl-auto: none  # JPAê°€ ìŠ¤í‚¤ë§ˆ ê´€ë ¨ ì‘ì—… ì•ˆí•¨
```

---

### 7. ë¡œê¹… ì„¤ì • (logback-spring.xml)

í˜„ì¬ `logs/` í´ë”ì— íŒŒì¼ ë¡œê·¸ ì €ì¥:
```xml
<file>logs/application.log</file>
```

**âš ï¸ Docker/Railway í™˜ê²½:**
- ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ë¡œê·¸ íŒŒì¼ì€ íœ˜ë°œì„±
- RailwayëŠ” Logs íƒ­ì—ì„œ stdout/stderr í™•ì¸ ê°€ëŠ¥

#### ê¶Œì¥ ì„¤ì • (ìš´ì˜)
1. **ì½˜ì†” ë¡œê·¸ ìœ ì§€** (Railway Logsì—ì„œ í™•ì¸)
2. **íŒŒì¼ ë¡œê·¸ëŠ” Volume ë§ˆìš´íŠ¸í•˜ê±°ë‚˜** ì™¸ë¶€ ë¡œê·¸ ì„œë¹„ìŠ¤ ì‚¬ìš© (CloudWatch, Papertrail ë“±)

---

### 8. Actuator ë³´ì•ˆ

#### í˜„ì¬ ì„¤ì •
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health, info, metrics
```

```java
.requestMatchers("/actuator/**").permitAll()  // ëª¨ë‘ í—ˆìš©ë¨
```

**âš ï¸ ë¯¼ê°í•œ ì •ë³´ ë…¸ì¶œ ê°€ëŠ¥:**
- `/actuator/health` - ì„œë²„ ìƒíƒœ (OK)
- `/actuator/info` - ì•± ì •ë³´
- `/actuator/metrics` - ë©”íŠ¸ë¦­ ì •ë³´ (ì£¼ì˜)

#### ê¶Œì¥ ì„¤ì •
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health, info  # metrics ì œì™¸
  endpoint:
    health:
      show-details: never  # ìƒì„¸ ì •ë³´ ìˆ¨ê¹€
```

---

### 9. Swagger ìš´ì˜ í™˜ê²½ ë¹„í™œì„±í™”

í˜„ì¬ `/swagger-ui.html` ì ‘ê·¼ ê°€ëŠ¥ (permitAll)

#### ê¶Œì¥: ìš´ì˜ì—ì„œ Swagger ë¹„í™œì„±í™”
`application-prod.yml` ì¶”ê°€:
```yaml
springdoc:
  api-docs:
    enabled: false
  swagger-ui:
    enabled: false
```

---

### 10. ì‹œê°„ëŒ€(Timezone) ì„¤ì •

#### Dockerfile í™•ì¸ âœ…
```dockerfile
ENV TZ=Asia/Seoul
RUN apk add --no-cache tzdata curl && \
    cp /usr/share/zoneinfo/$TZ /etc/localtime
```

**DB ì‹œê°„ëŒ€ë„ í™•ì¸:**
```yaml
# docker-compose.yml
environment:
  TZ: Asia/Seoul  # ì„¤ì •ë¨ âœ…
```

---

## ğŸ“‹ ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

| í•­ëª© | ë¡œì»¬ | ìš´ì˜ | í™•ì¸ |
|------|:----:|:----:|:----:|
| í™˜ê²½ë³€ìˆ˜ ì„¤ì • | .env | Railway Variables | â¬œ |
| OAuth2 Redirect URI | localhost:8080 | Railway URL | â¬œ |
| CORS ë„ë©”ì¸ | localhost | ìš´ì˜ ë„ë©”ì¸ ì¶”ê°€ | â¬œ |
| ì¿ í‚¤ Secure ì„¤ì • | false | true (HTTPS) | â¬œ |
| íŒŒì¼ ì—…ë¡œë“œ ì˜ì†ì„± | ë¡œì»¬ í´ë” | Volume ë˜ëŠ” S3 | â¬œ |
| DDL ì „ëµ | create | validate ë˜ëŠ” none | â¬œ |
| Swagger ë¹„í™œì„±í™” | í™œì„±í™” | ë¹„í™œì„±í™” | â¬œ |
| Actuator ë³´ì•ˆ | ê°œë°© | ìµœì†Œí™” | â¬œ |

---

## ğŸ”§ ë‹¤ìŒ ë‹¨ê³„

1. Railway Variablesì— í™˜ê²½ë³€ìˆ˜ ì„¤ì • í™•ì¸
2. ì¹´ì¹´ì˜¤/êµ¬ê¸€ ê°œë°œì ì½˜ì†”ì— ìš´ì˜ Redirect URI ë“±ë¡
3. ìš´ì˜ ë°°í¬ í›„ `/actuator/health` ë¡œ ì„œë²„ ìƒíƒœ í™•ì¸
4. OAuth2 ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
5. í•„ìš”ì‹œ CorsConfig, ì¿ í‚¤ Secure ì„¤ì • ìˆ˜ì •
